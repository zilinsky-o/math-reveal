<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Picture Reveal Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Comic Sans MS', cursive;
            background: linear-gradient(135deg, #fce7f3 0%, #f3e8ff 50%, #dbeafe 100%);
            min-height: 100vh;
            padding: 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        body.level-2 {

        body.level-3 {
            background: linear-gradient(135deg, #ccfbf1 0%, #fed7aa 50%, #14b8a6 100%);
        }
        
        body.level-4 {
            background: linear-gradient(135deg, #ccfbf1 0%, #99f6e4 50%, #5eead4 100%);
        }

        body.level-4 {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 50%, #6ee7b7 100%);
        }
        
        body.level-5 {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 50%, #a5b4fc 100%);
        }

        body.level-6 {
            background: linear-gradient(135deg, #1f1f1f 0%, #4a0000 50%, #1a0a0a 100%);
        }
        
        .container {
            max-width: 1400px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .main-content {
            display: flex;
            gap: 2rem;
            align-items: flex-start;
            width: 100%;
            justify-content: center;
        }
        
        .collectibles-pane {
            display: none;
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            border: 4px solid #e9d5ff;
            box-shadow: 0 20px 25px rgba(0,0,0,0.15);
            width: 180px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        body.level-2 .collectibles-pane {

        body.level-3 .collectibles-pane {
            border-color: #14b8a6;
            background: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 100%);
            box-shadow: 0 20px 25px rgba(20, 184, 166, 0.2);
        }

        body.level-4 .collectibles-pane {
            border-color: #10b981;
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            box-shadow: 0 20px 25px rgba(16, 185, 129, 0.2);
        }
        
        body.level-5 .collectibles-pane {
            border-color: #6366f1;
            background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
            box-shadow: 0 20px 25px rgba(99, 102, 241, 0.2);
        }

        body.level-6 .collectibles-pane {
            border-color: #dc2626;
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            box-shadow: 0 20px 25px rgba(220, 38, 38, 0.2);
        }
        
        .collectibles-pane h3 {
            color: #9333ea;
            font-size: 1.3rem;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        body.level-2 .collectibles-pane h3 {

        body.level-3 .collectibles-pane h3 {
            color: #0d9488;
        }

        body.level-4 .collectibles-pane h3 {
            color: #059669;
        }
        
        body.level-5 .collectibles-pane h3 {
            color: #4f46e5;
        }

        body.level-6 .collectibles-pane h3 {
            color: #dc2626;
        }
        
        .collectibles-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            max-height: 420px;
            overflow-y: auto;
        }
        
        .collectible-item {
            background: #f3f4f6;
            border-radius: 0.5rem;
            padding: 0.5rem;
            text-align: center;
            font-size: 2rem;
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
        }
        
        .collectible-item:hover {
            transform: scale(1.1);
        }
        
        .collectible-count-badge {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .collectible-empty {
            text-align: center;
            color: #9ca3af;
            font-size: 0.9rem;
            padding: 1rem;
            grid-column: 1 / -1;
        }
        
        @media (min-width: 1200px) {
            .collectibles-pane {
                display: block;
            }
        }
        
        .level-intro {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
            animation: fadeIn 0.5s;
        }
        
        .level-intro.visible {
            display: flex;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .level-intro-content {
            background: white;
            border-radius: 2rem;
            padding: 3rem;
            text-align: center;
            box-shadow: 0 30px 60px rgba(0,0,0,0.3);
            animation: scaleIn 0.5s;
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.8); }
            to { transform: scale(1); }
        }
        
        .level-intro h1 {
            font-size: 4rem;
            background: linear-gradient(135deg, #9333ea 0%, #ec4899 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
        }
        
        body.level-2 .level-intro h1 {

        body.level-3 .level-intro h1 {
            background: linear-gradient(135deg, #0d9488 0%, #ef4444 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        body.level-4 .level-intro h1 {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        body.level-5 .level-intro h1 {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        body.level-6 .level-intro h1 {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .level-intro p {
            font-size: 1.5rem;
            color: #6b7280;
            margin-bottom: 2rem;
        }
        
        .start-level-button {
            background: linear-gradient(135deg, #c084fc 0%, #f9a8d4 100%);
            color: white;
            font-family: 'Comic Sans MS', cursive;
            font-size: 2rem;
            font-weight: bold;
            padding: 1rem 3rem;
            border-radius: 9999px;
            border: none;
            cursor: pointer;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }
        
        body.level-2 .start-level-button {

        body.level-3 .start-level-button {
            background: linear-gradient(135deg, #14b8a6 0%, #f97316 100%);
        }
        
        body.level-4 .start-level-button {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        body.level-5 .start-level-button {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        }

        body.level-6 .start-level-button {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
        }
        
        .start-level-button:hover {
            transform: scale(1.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        h1 {
            color: #9333ea;
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        
        body.level-2 h1 {

        body.level-3 h1 {
            color: #0d9488;
        }
        
        body.level-4 h1 {
            color: #059669;
        }
        
        body.level-5 h1 {
            color: #4f46e5;
        }

        body.level-6 h1 {
            color: #dc2626;
        }
        
        .level-badge {
            display: inline-block;
            background: linear-gradient(135deg, #c084fc 0%, #f9a8d4 100%);
            color: white;
            padding: 0.5rem 1.5rem;
            border-radius: 9999px;
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 1rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        body.level-2 .level-badge {

        body.level-3 .level-badge {
            background: linear-gradient(135deg, #14b8a6 0%, #f97316 100%);
        }
        
        body.level-4 .level-badge {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        body.level-5 .level-badge {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        }

        body.level-6 .level-badge {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
        }
        
        .progress-bar {
            display: flex;
            gap: 1rem;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .progress {
            background: white;
            border-radius: 9999px;
            padding: 0.5rem 1.5rem;
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
        }
        
        .progress p {
            color: #a855f7;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        body.level-2 .progress p {

        body.level-3 .progress p {
            color: #0d9488;
        }
        
        body.level-4 .progress p {
            color: #059669;
        }
        
        body.level-5 .progress p {
            color: #4f46e5;
        }

        body.level-6 .progress p {
            color: #dc2626;
        }
        
        .mistakes {
            background: white;
            border-radius: 9999px;
            padding: 0.5rem 1.5rem;
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
        }
        
        .mistakes p {
            color: #f59e0b;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .collection-badge {
            background: white;
            border-radius: 9999px;
            padding: 0.5rem 1.5rem;
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .collection-badge:hover {
            transform: scale(1.05);
        }
        
        .collection-badge p {
            color: #8b5cf6;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .restart-button, .pause-button {
            background: #ef4444;
            color: white;
            font-weight: bold;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            border: none;
            cursor: pointer;
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
            font-size: 1rem;
        }
        
        .pause-button {
            background: #f59e0b;
        }
        
        .restart-button:hover {
            background: #dc2626;
        }
        
        .pause-button:hover {
            background: #d97706;
        }

        .game-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }

        .game-board {
            position: relative;
            width: 500px;
            height: 500px;
        }
        
        .background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #ffc0cb 0%, #e9d5ff 50%, #bfdbfe 100%);
            border-radius: 0.5rem;
            box-shadow: 0 20px 25px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        body.level-2 .background {

        body.level-3 .background {
            box-shadow: 0 20px 25px rgba(20, 184, 166, 0.3);
            border: 4px solid #14b8a6;
        }
        
        body.level-4 .background {
            box-shadow: 0 20px 25px rgba(16, 185, 129, 0.3);
            border: 4px solid #10b981;
        }
        
        body.level-5 .background {
            box-shadow: 0 20px 25px rgba(99, 102, 241, 0.3);
            border: 4px solid #6366f1;
        }

        body.level-6 .background {
            box-shadow: 0 20px 25px rgba(220, 38, 38, 0.3);
            border: 4px solid #dc2626;
        }
        
        .emoji {
            font-size: 400px;
            line-height: 500px;
        }
        
        .grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 0.5rem;
            overflow: hidden;
            pointer-events: none;
        }
        
        .grid-row {
            display: flex;
            height: 62.5px;
        }
        
        .grid-cell {
            position: relative;
            width: 62.5px;
            height: 62.5px;
            border: 2px solid #9333ea;
            box-sizing: border-box;
            overflow: hidden;
        }
        
        body.level-2 .grid-cell {

        body.level-3 .grid-cell {
            border-color: #0d9488;
        }
        
        body.level-4 .grid-cell {
            border-color: #10b981;
        }
        
        body.level-5 .grid-cell {
            border-color: #6366f1;
        }

        body.level-6 .grid-cell {
            border-color: #dc2626;
        }

        /* Pathfinding cells */
        .pathfinding-cell {
            position: relative;
            width: 55px;
            height: 55px;
            border: 2px solid #14b8a6;
            box-sizing: border-box;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pathfinding-cell.tile-covered {
            background-color: #99f6e4;
        }

        .pathfinding-cell.tile-paved {
            background-color: #ccfbf1;
            background-image: repeating-linear-gradient(
                45deg,
                #5eead4 0px,
                #5eead4 10px,
                #99f6e4 10px,
                #99f6e4 20px
            );
        }

        .pathfinding-cell.tile-blocked {
            background-color: #4b5563;
            background-image:
                linear-gradient(45deg, #1f2937 25%, transparent 25%),
                linear-gradient(-45deg, #1f2937 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #1f2937 75%),
                linear-gradient(-45deg, transparent 75%, #1f2937 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            cursor: not-allowed;
        }

        .pathfinding-cell.adjacent {
            background-color: #fef08a;
            border-color: #facc15;
            animation: pulse 1s infinite;
        }

        .pathfinding-cell.movable {
            cursor: pointer;
            border-color: #5eead4;
        }

        .pathfinding-cell.movable:hover {
            background-color: #e0f2fe;
            transform: scale(1.05);
        }

        .pathfinding-cell.adjacent:hover {
            background-color: #fde047;
            transform: scale(1.1);
        }

        .avatar {
            font-size: 2rem;
            position: absolute;
            z-index: 10;
            animation: avatarBounce 0.5s;
        }

        .chest {
            font-size: 2rem;
            position: absolute;
            z-index: 5;
        }

        .pathfinding-cell.has-avatar.has-chest .avatar {
            transform: translateX(-10px);
        }

        .pathfinding-cell.has-avatar.has-chest .chest {
            transform: translateX(10px);
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(250, 204, 21, 0.7);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(250, 204, 21, 0);
            }
        }

        @keyframes avatarBounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        .cell-cover {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 192, 203, 1);
            transition: opacity 0.5s ease;
        }
        
        body.level-2 .cell-cover {

        body.level-3 .cell-cover {
            background-color: rgba(251, 191, 36, 1);
        }
        
        body.level-4 .cell-cover {
            background-color: rgba(16, 185, 129, 1);
        }
        
        body.level-5 .cell-cover {
            background-color: rgba(99, 102, 241, 1);
        }

        body.level-6 .cell-cover {
            background-color: rgba(220, 38, 38, 1);
        }
        
        .cell-cracks {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        .question-box {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            border: 4px solid #e9d5ff;
            box-shadow: 0 20px 25px rgba(0,0,0,0.15);
            width: 400px;
            text-align: center;
            position: relative;
        }
        
        body.level-2 .question-box {

        body.level-3 .question-box {
            border-color: #14b8a6;
            background: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 100%);
            box-shadow: 0 20px 25px rgba(20, 184, 166, 0.2);
        }
        
        body.level-4 .question-box {
            border-color: #10b981;
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            box-shadow: 0 20px 25px rgba(16, 185, 129, 0.2);
        }
        
        body.level-5 .question-box {
            border-color: #6366f1;
            background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
            box-shadow: 0 20px 25px rgba(99, 102, 241, 0.2);
        }

        body.level-6 .question-box {
            border-color: #dc2626;
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            box-shadow: 0 20px 25px rgba(220, 38, 38, 0.2);
        }
        
        .paused-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 1rem;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        
        .paused-overlay.visible {
            display: flex;
        }
        
        .paused-text {
            font-size: 2rem;
            color: #9333ea;
            font-weight: bold;
        }
        
        body.level-2 .paused-text {

        body.level-3 .paused-text {
            color: #0d9488;
        }
        
        body.level-4 .paused-text {
            color: #059669;
        }
        
        body.level-5 .paused-text {
            color: #4f46e5;
        }

        body.level-6 .paused-text {
            color: #dc2626;
        }
        
        .timer {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 0.9rem;
            font-weight: bold;
            color: #9333ea;
            opacity: 0.6;
        }
        
        body.level-2 .timer {

        body.level-3 .timer {
            color: #0d9488;
        }
        
        body.level-4 .timer {
            color: #059669;
        }
        
        body.level-5 .timer {
            color: #4f46e5;
        }

        body.level-6 .timer {
            color: #dc2626;
        }
        
        .question {
            color: #9333ea;
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
        }
        
        body.level-2 .question {

        body.level-3 .question {
            color: #0d9488;
        }
        
        body.level-4 .question {
            color: #059669;
        }
        
        body.level-5 .question {
            color: #4f46e5;
        }

        body.level-6 .question {
            color: #dc2626;
        }
        
        .answer-input {
            font-family: 'Comic Sans MS', cursive;
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            width: 130px;
            padding: 0.75rem 1rem;
            border: 4px solid #d8b4fe;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
        }
        
        body.level-2 .answer-input {

        body.level-3 .answer-input {
            border-color: #14b8a6;
        }
        
        body.level-4 .answer-input {
            border-color: #10b981;
        }
        
        body.level-5 .answer-input {
            border-color: #6366f1;
        }

        body.level-6 .answer-input {
            border-color: #dc2626;
        }
        
        .answer-input:focus {
            outline: none;
            border-color: #9333ea;
        }
        
        body.level-2 .answer-input:focus {

        body.level-3 .answer-input:focus {
            border-color: #0d9488;
        }
        
        body.level-4 .answer-input:focus {
            border-color: #059669;
        }
        
        body.level-5 .answer-input:focus {
            border-color: #4f46e5;
        }

        body.level-6 .answer-input:focus {
            border-color: #dc2626;
        }
        
        .check-button {
            background: linear-gradient(135deg, #c084fc 0%, #f9a8d4 100%);
            color: white;
            font-family: 'Comic Sans MS', cursive;
            font-size: 1.5rem;
            font-weight: bold;
            padding: 0.75rem 2rem;
            border-radius: 9999px;
            border: none;
            cursor: pointer;
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        
        body.level-2 .check-button {

        body.level-3 .check-button {
            background: linear-gradient(135deg, #14b8a6 0%, #f97316 100%);
        }
        
        body.level-4 .check-button {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        body.level-5 .check-button {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        }

        body.level-6 .check-button {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
        }
        
        .check-button:hover {
            background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
            transform: scale(1.05);
        }
        
        body.level-2 .check-button:hover {

        body.level-3 .check-button:hover {
            background: linear-gradient(135deg, #0d9488 0%, #dc2626 100%);
        }
        
        body.level-4 .check-button:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }
        
        body.level-5 .check-button:hover {
            background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%);
        }

        body.level-6 .check-button:hover {
            background: linear-gradient(135deg, #991b1b 0%, #7f1d1d 100%);
        }
        
        .feedback {
            font-size: 1.5rem;
            font-weight: bold;
            margin-top: 1rem;
        }
        
        .feedback.correct {
            color: #10b981;
        }
        
        .feedback.incorrect {
            color: #f59e0b;
        }
        
        .completion {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            border: 4px solid #e9d5ff;
            box-shadow: 0 20px 25px rgba(0,0,0,0.15);
            width: 500px;
            text-align: center;
        }
        
        body.level-2 .completion {

        body.level-3 .completion {
            border-color: #14b8a6;
            background: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 100%);
            box-shadow: 0 20px 25px rgba(20, 184, 166, 0.2);
        }
        
        body.level-4 .completion {
            border-color: #10b981;
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            box-shadow: 0 20px 25px rgba(16, 185, 129, 0.2);
        }
        
        body.level-5 .completion {
            border-color: #6366f1;
            background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
            box-shadow: 0 20px 25px rgba(99, 102, 241, 0.2);
        }

        body.level-6 .completion {
            border-color: #dc2626;
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            box-shadow: 0 20px 25px rgba(220, 38, 38, 0.2);
        }
        
        .completion h2 {
            color: #9333ea;
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        
        body.level-2 .completion h2 {

        body.level-3 .completion h2 {
            color: #0d9488;
        }
        
        body.level-4 .completion h2 {
            color: #059669;
        }
        
        body.level-5 .completion h2 {
            color: #4f46e5;
        }

        body.level-6 .completion h2 {
            color: #dc2626;
        }
        
        .completion p {
            color: #a855f7;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }
        
        body.level-2 .completion p {

        body.level-3 .completion p {
            color: #0d9488;
        }
        
        body.level-4 .completion p {
            color: #059669;
        }
        
        body.level-5 .completion p {
            color: #4f46e5;
        }

        body.level-6 .completion p {
            color: #dc2626;
        }
        
        .new-collectible {
            font-size: 5rem;
            margin: 1rem 0;
            animation: bounce 1s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        
        .next-level-button {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            font-family: 'Comic Sans MS', cursive;
            font-size: 1.5rem;
            font-weight: bold;
            padding: 1rem 2rem;
            border-radius: 9999px;
            border: none;
            cursor: pointer;
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
            margin-top: 1rem;
            transition: all 0.3s;
        }
        
        .next-level-button:hover {
            transform: scale(1.05);
        }
        
        .mistake-report, .achievement-report {
            margin-top: 1.5rem;
            padding: 1rem;
            background: #fef3c7;
            border-radius: 0.5rem;
            text-align: left;
        }
        
        .achievement-report {
            background: #d1fae5;
        }
        
        .mistake-report h3, .achievement-report h3 {
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
        }
        
        .mistake-report h3 {
            color: #f59e0b;
        }
        
        .achievement-report h3 {
            color: #059669;
        }
        
        .mistake-report ul, .achievement-report ul {
            list-style: none;
            font-size: 1.1rem;
        }
        
        .mistake-report ul {
            color: #92400e;
        }
        
        .achievement-report ul {
            color: #065f46;
        }
        
        .mistake-report li, .achievement-report li {
            margin: 0.3rem 0;
        }
        
        .collection-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        
        .collection-modal.visible {
            display: flex;
        }
        
        .collection-content {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        
        .collection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .collection-header h2 {
            color: #9333ea;
            font-size: 2rem;
        }
        
        .close-button {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .collection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 1rem;
        }
        
        .collection-item {
            background: #f3f4f6;
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
            font-size: 3rem;
            position: relative;
            cursor: help;
        }
        
        .collection-item-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            margin-bottom: 0.5rem;
            z-index: 10;
        }
        
        .collection-item:hover .collection-item-tooltip {
            opacity: 1;
        }
        
        .delete-collectible {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 1rem;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            z-index: 20;
        }
        
        .collection-item:hover .delete-collectible {
            display: flex;
        }
        
        .test-panel {
            position: fixed;
            top: 1rem;
            left: 1rem;
            background: #fee;
            border: 2px solid #f00;
            padding: 1rem;
            border-radius: 0.5rem;
            display: none;
            z-index: 50;
        }
        
        .test-panel.visible {
            display: block;
        }
        
        .test-panel h3 {
            color: #f00;
            margin-bottom: 0.5rem;
        }
        
        .test-button {
            background: #f00;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.25rem;
            cursor: pointer;
            font-weight: bold;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .version-info {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background: rgba(255, 255, 255, 0.8);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            color: #6b7280;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Boss Battle Styles */
        .boss-arena {
            position: relative;
            width: 800px;
            height: 400px;
            background: linear-gradient(135deg, #2d1b1b 0%, #1a0505 100%);
            border-radius: 1rem;
            border: 4px solid #dc2626;
            box-shadow: 0 20px 25px rgba(220, 38, 38, 0.4);
            overflow: hidden;
        }

        .boss-ground {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: linear-gradient(135deg, #3f1f1f 0%, #2d0a0a 100%);
            border-top: 3px solid #7f1d1d;
        }

        .boss-avatar {
            position: absolute;
            bottom: 60px;
            left: 10%;
            font-size: 80px;
            transform: translateX(-50%);
            transition: transform 0.3s;
            z-index: 10;
        }

        .boss-character {
            position: absolute;
            bottom: 60px;
            font-size: 120px;
            transform: translateX(-50%);
            transition: left 0.5s ease-out;
            z-index: 5;
        }

        .boss-prison {
            position: absolute;
            bottom: 60px;
            right: 5%;
            font-size: 100px;
            transform: translateX(50%);
        }

        .boss-ball {
            position: absolute;
            font-size: 40px;
            opacity: 0;
            pointer-events: none;
            z-index: 15;
        }

        @keyframes throwBall {
            0% {
                left: 10%;
                bottom: 140px;
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
            50% {
                bottom: 200px;
                transform: scale(1.2) rotate(180deg);
            }
            100% {
                opacity: 1;
                transform: scale(0.8) rotate(360deg);
            }
        }

        .boss-progress-bar {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 600px;
            height: 30px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            border: 2px solid #7f1d1d;
            overflow: hidden;
        }

        .boss-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #dc2626 0%, #991b1b 100%);
            transition: width 0.5s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 0.9rem;
        }

        .boss-danger-zone {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: #fca5a5;
            font-size: 1rem;
            font-weight: bold;
            text-align: center;
            width: 600px;
            margin-top: 55px;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(-50%) rotate(0deg); }
            25% { transform: translateX(-50%) rotate(-5deg); }
            75% { transform: translateX(-50%) rotate(5deg); }
        }

        .boss-character.angry {
            animation: shake 0.3s ease-in-out;
        }

        .boss-avatar.celebrating {
            animation: bounce 0.5s ease-in-out;
        }
    </style>
</head>
<body>
    <div class="version-info">v2.0.0</div>
    
    <div class="test-panel" id="test-panel">
        <h3>🔧 Test Panel</h3>
        <button class="test-button" onclick="revealAll()">Reveal All & End</button>
        <button class="test-button" onclick="viewCollection()">View Collection</button>
        <div style="margin-top: 0.5rem;">
            <label style="color: #f00; font-weight: bold; margin-right: 0.5rem;">Add Collectible:</label>
            <br>
            <select id="collectible-selector" style="padding: 0.5rem; border-radius: 0.25rem; border: 1px solid #f00; font-family: 'Comic Sans MS', cursive; font-weight: bold; margin-top: 0.25rem; width: 200px;">
            </select>
            <button class="test-button" onclick="addTestCollectible()" style="margin-left: 0.5rem; margin-top: 0.25rem;">Add to Collection</button>
        </div>
        <div style="margin-top: 0.5rem;">
            <label style="color: #f00; font-weight: bold; margin-right: 0.5rem;">Jump to:</label>
            <select id="level-selector" onchange="jumpToLevel(parseInt(this.value))" style="padding: 0.5rem; border-radius: 0.25rem; border: 1px solid #f00; font-family: 'Comic Sans MS', cursive; font-weight: bold;">
                <option value="1">Level 1</option>
                <option value="2">Level 2</option>
                <option value="3">Level 3 (Pathfinding)</option>
                <option value="4">Level 4</option>
                <option value="5">Level 5</option>
                <option value="6">Level 6 (Boss)</option>
            </select>
        </div>
    </div>

    <div class="level-intro" id="level-intro">
        <div class="level-intro-content">
            <div id="boss-intro-emoji" style="font-size: 8rem; margin: 1rem 0; display: none;">👹</div>
            <h1 id="level-intro-title">LEVEL 1</h1>
            <p id="level-intro-desc">Practice Addition!</p>
            <button class="start-level-button" onclick="startLevel()">START</button>
        </div>
    </div>

    <div class="level-intro" id="boss-loss-modal" style="display: none;">
        <div class="level-intro-content">
            <div style="font-size: 8rem; margin: 1rem 0;">💀</div>
            <h1 style="background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">DEFEATED!</h1>
            <p style="font-size: 1.5rem; color: #dc2626; margin-bottom: 2rem;">The boss reached you!</p>
            <button class="start-level-button" onclick="restartFromBossLoss()" style="background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);">TRY AGAIN</button>
        </div>
    </div>

    <div class="collection-modal" id="collection-modal">
        <div class="collection-content">
            <div class="collection-header">
                <h2>🎨 My Collection</h2>
                <button class="close-button" onclick="closeCollection()">×</button>
            </div>
            <div class="collection-grid" id="collection-grid"></div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="level-badge" id="level-badge">Level 1</div>
            <h1>Math Picture Reveal! ✨</h1>
            <div class="progress-bar">
                <div class="progress">
                    <p id="progress-text">0/64 Cells Discovered!</p>
                </div>
                <div class="mistakes">
                    <p id="mistakes-text">Mistakes: 0</p>
                </div>
                <div class="collection-badge" onclick="viewCollection()">
                    <p id="collection-count">📚 Collection: 0</p>
                </div>
                <button class="pause-button" id="pause-button" onclick="togglePause()">⏸️ Pause</button>
                <button class="restart-button" onclick="restartGame()">🔄 Restart</button>
            </div>
        </div>
        
        <div class="main-content">
            <div class="collectibles-pane" id="collectibles-pane">
                <h3>🎨 Collection</h3>
                <div class="collectibles-grid" id="collectibles-pane-grid"></div>
            </div>
            
            <div class="game-area">
                <div class="boss-arena" id="boss-arena" style="display: none;">
                    <div class="boss-progress-bar">
                        <div class="boss-progress-fill" id="boss-progress-fill" style="width: 50%;">
                            Boss Position
                        </div>
                    </div>
                    <div class="boss-danger-zone" id="boss-danger-zone"></div>
                    <div class="boss-avatar" id="boss-avatar">🧙</div>
                    <div class="boss-character" id="boss-character" style="left: 50%;">👹</div>
                    <div class="boss-prison" id="boss-prison" style="display: flex; align-items: center; justify-content: center; position: relative;">
                        <div style="font-size: 50px; position: absolute; color: #dc2626; font-weight: bold; letter-spacing: 5px; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);">| | | | |</div>
                        <div style="font-size: 80px; position: absolute; margin-top: -20px;">🔒</div>
                    </div>
                    <div class="boss-ball" id="boss-bomb">💣</div>
                    <div class="boss-ball" id="boss-explosion" style="font-size: 60px;">💥</div>
                    <div class="boss-ground"></div>
                </div>

                <div class="game-board" id="game-board">
                    <div class="background" id="background">
                        <div class="emoji" id="emoji">🦄</div>
                    </div>
                    <div class="grid-overlay" id="grid"></div>
                </div>
                
                <div class="question-box" id="question-box">
                    <div class="paused-overlay" id="paused-overlay">
                        <div class="paused-text">⏸️ Paused</div>
                    </div>
                    <div class="timer" id="timer">0s</div>
                    <div class="question" id="question">What is 2 + 2?</div>
                    <input type="number" class="answer-input" id="answer-input" autofocus>
                    <br>
                    <button class="check-button" onclick="checkAnswer()">Check Answer!</button>
                    <div class="feedback" id="feedback"></div>
                </div>
            </div>
        </div>
        
        <div class="completion" id="completion" style="display: none;">
            <h2>🎉 Amazing Work! 🎉</h2>
            <p id="completion-text">You revealed the Unicorn!</p>
            <div class="new-collectible" id="new-collectible">🦄</div>
            <p style="color: #8b5cf6; font-size: 1.3rem; font-weight: bold;">Added to your collection!</p>
            <button class="next-level-button" id="next-level-button" onclick="goToNextLevel()">Next Level →</button>
            <div id="reports-container"></div>
        </div>
    </div>

    <script>
        const GRID_SIZE = 8;
        const GRID_OFFSET = 2;
        const CELLS_PER_ANSWER = 6;
        const MIN_LEVEL_2_QUESTIONS = 10;
        const MIN_LEVEL_5_QUESTIONS = 10;
        const PATHFINDING_GRID_SIZE = 9;

        const PRACTICE_TYPES = {
            A: {
                name: 'Practice',
                cellsPerAnswer: 6,
                requiresRetry: true,
                questionSource: 'random'
            },
            B: {
                name: 'Challenge Review',
                cellsPerAnswer: (totalQuestions) => Math.ceil(64 / totalQuestions),
                requiresRetry: false,
                questionSource: 'practice-set',
                minQuestions: 10
            },
            C: {
                name: 'Boss Challenge',
                cellsPerAnswer: 4,
                requiresRetry: true,
                questionSource: 'mixed',
                timeLimit: null
            },
            D: {
                name: 'Pathfinding',
                cellsPerAnswer: 0, // Not used for pathfinding
                requiresRetry: false,
                questionSource: 'random'
            }
        };

        const QUESTION_TYPES = {
            'single-add': {
                operation: '+',
                operationFn: (a, b) => a + b,
                rowRange: [2, 10],
                colRange: [2, 10],
                label: 'Single-Digit Addition',
                operationSymbol: '+'
            },
            'double-add': {
                operation: '+',
                operationFn: (a, b) => a + b,
                rowRange: [11, 90],
                colRange: [2, 9],
                label: 'Double-Digit Addition',
                operationSymbol: '+'
            },
            'single-sub': {
                operation: '-',
                operationFn: (a, b) => a - b,
                rowRange: [2, 10],
                colRange: [2, 10],
                label: 'Single-Digit Subtraction',
                operationSymbol: '-'
            },
            'double-sub': {
                operation: '-',
                operationFn: (a, b) => a - b,
                rowRange: [11, 90],
                colRange: [2, 9],
                label: 'Double-Digit Subtraction',
                operationSymbol: '-'
            },
            'mixed-add': {
                operation: '+',
                operationFn: (a, b) => a + b,
                rowRange: [2, 90],
                colRange: [2, 10],
                label: 'Mixed Addition',
                operationSymbol: '+'
            },
            'mixed-sub': {
                operation: '-',
                operationFn: (a, b) => a - b,
                rowRange: [2, 90],
                colRange: [2, 10],
                label: 'Mixed Subtraction',
                operationSymbol: '-'
            }
        };

        const LEVEL_CONFIG = {
            1: {
                practiceType: 'A',
                questionType: 'single-add',
                theme: 'purple',
                sourceLevel: null,
                title: 'LEVEL 1',
                description: 'Practice Addition!'
            },
            2: {
                practiceType: 'B',
                questionType: 'single-add',
                theme: 'orange',
                sourceLevel: 1,
                title: 'LEVEL 2',
                description: (numQuestions) => `Practice ${numQuestions} Challenging Questions!`
            },
            3: {
                practiceType: 'D',
                questionType: 'single-add',
                theme: 'teal',
                sourceLevel: null,
                title: 'LEVEL 3',
                description: 'Find the Treasure!'
            },
            4: {
                practiceType: 'A',
                questionType: 'double-add',
                theme: 'green',
                sourceLevel: null,
                title: 'LEVEL 4',
                description: 'Double Digit Addition!'
            },
            5: {
                practiceType: 'B',
                questionType: 'double-add',
                theme: 'indigo',
                sourceLevel: 4,
                title: 'LEVEL 5',
                description: (numQuestions) => `Practice ${numQuestions} Challenging Questions!`
            },
            6: {
                practiceType: 'C',
                questionType: 'mixed',
                theme: 'red',
                sourceLevel: null,
                title: 'BOSS LEVEL 6',
                description: 'Defeat the Boss!'
            }
        };

        const urlParams = new URLSearchParams(window.location.search);
        const testMode = urlParams.get('test') === 'true';
        if (testMode) {
            document.getElementById('test-panel').classList.add('visible');
        }
        
        const backgrounds = [
            { gradient: 'linear-gradient(135deg, #ffc0cb 0%, #e9d5ff 50%, #bfdbfe 100%)', emoji: '🦄', name: 'Unicorn', baseRarity: 'legendary' },
            { gradient: 'linear-gradient(135deg, #fef3c7 0%, #fed7aa 50%, #ffc0cb 100%)', emoji: '🐱', name: 'Kitty', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 50%, #bfdbfe 100%)', emoji: '🐬', name: 'Dolphin', baseRarity: 'rare' },
            { gradient: 'linear-gradient(135deg, #fef08a 0%, #fde047 50%, #fcd34d 100%)', emoji: '🐻', name: 'Bear', baseRarity: 'uncommon' },
            { gradient: 'linear-gradient(135deg, #fecaca 0%, #fca5a5 50%, #f87171 100%)', emoji: '🦊', name: 'Fox', baseRarity: 'uncommon' },
            { gradient: 'linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 50%, #a78bfa 100%)', emoji: '🦋', name: 'Butterfly', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #fde68a 0%, #fcd34d 50%, #fbbf24 100%)', emoji: '🐝', name: 'Bee', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #fed7aa 0%, #fdba74 50%, #fb923c 100%)', emoji: '🦁', name: 'Lion', baseRarity: 'rare' },
            { gradient: 'linear-gradient(135deg, #bae6fd 0%, #7dd3fc 50%, #38bdf8 100%)', emoji: '🐧', name: 'Penguin', baseRarity: 'uncommon' },
            { gradient: 'linear-gradient(135deg, #d9f99d 0%, #bef264 50%, #a3e635 100%)', emoji: '🐸', name: 'Frog', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #fecdd3 0%, #fda4af 50%, #fb7185 100%)', emoji: '🐷', name: 'Pig', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 50%, #a5b4fc 100%)', emoji: '🐘', name: 'Elephant', baseRarity: 'rare' },
            { gradient: 'linear-gradient(135deg, #ccfbf1 0%, #99f6e4 50%, #5eead4 100%)', emoji: '🦕', name: 'Dinosaur', baseRarity: 'legendary' },
            { gradient: 'linear-gradient(135deg, #fce7f3 0%, #fbcfe8 50%, #f9a8d4 100%)', emoji: '🦩', name: 'Flamingo', baseRarity: 'uncommon' },
            { gradient: 'linear-gradient(135deg, #fef9c3 0%, #fef08a 50%, #fde047 100%)', emoji: '🐥', name: 'Chick', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #f5f3ff 0%, #ede9fe 50%, #ddd6fe 100%)', emoji: '🦉', name: 'Owl', baseRarity: 'uncommon' },
            { gradient: 'linear-gradient(135deg, #ffedd5 0%, #fed7aa 50%, #fdba74 100%)', emoji: '🦘', name: 'Kangaroo', baseRarity: 'rare' },
            { gradient: 'linear-gradient(135deg, #dbeafe 0%, #bfdbfe 50%, #93c5fd 100%)', emoji: '🐋', name: 'Whale', baseRarity: 'epic' },
            { gradient: 'linear-gradient(135deg, #fef3c7 0%, #fde047 50%, #facc15 100%)', emoji: '🐤', name: 'Baby Chick', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #fed7aa 0%, #fb923c 50%, #f97316 100%)', emoji: '🦀', name: 'Crab', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #e0f2fe 0%, #7dd3fc 50%, #0ea5e9 100%)', emoji: '🐟', name: 'Fish', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #d1fae5 0%, #6ee7b7 50%, #10b981 100%)', emoji: '🐢', name: 'Turtle', baseRarity: 'uncommon' },
            { gradient: 'linear-gradient(135deg, #fef08a 0%, #facc15 50%, #eab308 100%)', emoji: '🐭', name: 'Mouse', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #fecaca 0%, #f87171 50%, #ef4444 100%)', emoji: '🐹', name: 'Hamster', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #ddd6fe 0%, #a78bfa 50%, #8b5cf6 100%)', emoji: '🐰', name: 'Rabbit', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #fed7aa 0%, #fdba74 50%, #f97316 100%)', emoji: '🦔', name: 'Hedgehog', baseRarity: 'uncommon' },
            { gradient: 'linear-gradient(135deg, #d9f99d 0%, #a3e635 50%, #84cc16 100%)', emoji: '🦎', name: 'Lizard', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #fbcfe8 0%, #f472b6 50%, #ec4899 100%)', emoji: '🐙', name: 'Octopus', baseRarity: 'uncommon' },
            { gradient: 'linear-gradient(135deg, #bae6fd 0%, #38bdf8 50%, #0284c7 100%)', emoji: '🦈', name: 'Shark', baseRarity: 'rare' },
            { gradient: 'linear-gradient(135deg, #fde68a 0%, #fbbf24 50%, #f59e0b 100%)', emoji: '🐨', name: 'Koala', baseRarity: 'rare' },
            { gradient: 'linear-gradient(135deg, #c7d2fe 0%, #818cf8 50%, #6366f1 100%)', emoji: '🦇', name: 'Bat', baseRarity: 'uncommon' },
            { gradient: 'linear-gradient(135deg, #fecdd3 0%, #fb7185 50%, #f43f5e 100%)', emoji: '🦞', name: 'Lobster', baseRarity: 'uncommon' },
            { gradient: 'linear-gradient(135deg, #ccfbf1 0%, #5eead4 50%, #14b8a6 100%)', emoji: '🐊', name: 'Crocodile', baseRarity: 'rare' },
            { gradient: 'linear-gradient(135deg, #fef9c3 0%, #fde047 50%, #facc15 100%)', emoji: '🦒', name: 'Giraffe', baseRarity: 'rare' },
            { gradient: 'linear-gradient(135deg, #e0e7ff 0%, #a5b4fc 50%, #818cf8 100%)', emoji: '🦏', name: 'Rhino', baseRarity: 'epic' },
            { gradient: 'linear-gradient(135deg, #d1fae5 0%, #6ee7b7 50%, #34d399 100%)', emoji: '🦛', name: 'Hippo', baseRarity: 'rare' },
            { gradient: 'linear-gradient(135deg, #fed7aa 0%, #fb923c 50%, #ea580c 100%)', emoji: '🐯', name: 'Tiger', baseRarity: 'epic' },
            { gradient: 'linear-gradient(135deg, #fef3c7 0%, #fcd34d 50%, #f59e0b 100%)', emoji: '🐵', name: 'Monkey', baseRarity: 'uncommon' },
            { gradient: 'linear-gradient(135deg, #fecaca 0%, #fca5a5 50%, #f87171 100%)', emoji: '🦙', name: 'Llama', baseRarity: 'uncommon' },
            { gradient: 'linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 50%, #a78bfa 100%)', emoji: '🦚', name: 'Peacock', baseRarity: 'rare' },
            { gradient: 'linear-gradient(135deg, #bae6fd 0%, #7dd3fc 50%, #38bdf8 100%)', emoji: '🐦', name: 'Bird', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #fde68a 0%, #fbbf24 50%, #f59e0b 100%)', emoji: '🐴', name: 'Horse', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #d9f99d 0%, #bef264 50%, #a3e635 100%)', emoji: '🦗', name: 'Cricket', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #fbcfe8 0%, #f9a8d4 50%, #f472b6 100%)', emoji: '🦟', name: 'Mosquito', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #ccfbf1 0%, #99f6e4 50%, #5eead4 100%)', emoji: '🐌', name: 'Snail', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #fef9c3 0%, #fef08a 50%, #fde047 100%)', emoji: '🦆', name: 'Duck', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 50%, #a5b4fc 100%)', emoji: '🦢', name: 'Swan', baseRarity: 'uncommon' },
            { gradient: 'linear-gradient(135deg, #fed7aa 0%, #fdba74 50%, #fb923c 100%)', emoji: '🦜', name: 'Parrot', baseRarity: 'uncommon' },
            { gradient: 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 50%, #6ee7b7 100%)', emoji: '🦖', name: 'T-Rex', baseRarity: 'legendary' },
            { gradient: 'linear-gradient(135deg, #fde68a 0%, #fcd34d 50%, #fbbf24 100%)', emoji: '🐿️', name: 'Squirrel', baseRarity: 'common' },
            // New Collectables - Common (8)
            { gradient: 'linear-gradient(135deg, #e5e7eb 0%, #d1d5db 50%, #9ca3af 100%)', emoji: '🐺', name: 'Wolf', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #d1d5db 0%, #9ca3af 50%, #6b7280 100%)', emoji: '🦝', name: 'Raccoon', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 50%, #d1d5db 100%)', emoji: '🐑', name: 'Sheep', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #fef3c7 0%, #fde68a 50%, #d97706 100%)', emoji: '🐮', name: 'Cow', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #6ee7b7 0%, #34d399 50%, #059669 100%)', emoji: '🪲', name: 'Beetle', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #d9f99d 0%, #a3e635 50%, #65a30d 100%)', emoji: '🐛', name: 'Caterpillar', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #9ca3af 0%, #6b7280 50%, #4b5563 100%)', emoji: '🪰', name: 'Fly', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #6b7280 0%, #4b5563 50%, #374151 100%)', emoji: '🦡', name: 'Badger', baseRarity: 'common' },
            // New Collectables - Uncommon (6)
            { gradient: 'linear-gradient(135deg, #d97706 0%, #b45309 50%, #92400e 100%)', emoji: '🦫', name: 'Beaver', baseRarity: 'uncommon' },
            { gradient: 'linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #bae6fd 100%)', emoji: '🐻‍❄️', name: 'Polar Bear', baseRarity: 'uncommon' },
            { gradient: 'linear-gradient(135deg, #92400e 0%, #78350f 50%, #451a03 100%)', emoji: '🦦', name: 'Otter', baseRarity: 'uncommon' },
            { gradient: 'linear-gradient(135deg, #1f2937 0%, #111827 50%, #030712 100%)', emoji: '🦨', name: 'Skunk', baseRarity: 'uncommon' },
            { gradient: 'linear-gradient(135deg, #78350f 0%, #451a03 50%, #292524 100%)', emoji: '🐗', name: 'Boar', baseRarity: 'uncommon' },
            { gradient: 'linear-gradient(135deg, #dc2626 0%, #b91c1c 50%, #991b1b 100%)', emoji: '🦃', name: 'Turkey', baseRarity: 'uncommon' },
            // New Collectables - Rare (4)
            { gradient: 'linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%)', emoji: '🦅', name: 'Eagle', baseRarity: 'rare' },
            { gradient: 'linear-gradient(135deg, #d97706 0%, #92400e 50%, #78350f 100%)', emoji: '🦌', name: 'Deer', baseRarity: 'rare' },
            { gradient: 'linear-gradient(135deg, #fef3c7 0%, #fde047 50%, #d97706 100%)', emoji: '🐪', name: 'Camel', baseRarity: 'rare' },
            { gradient: 'linear-gradient(135deg, #92400e 0%, #78350f 50%, #451a03 100%)', emoji: '🦬', name: 'Bison', baseRarity: 'rare' },
            // New Collectables - Epic (2)
            { gradient: 'linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #1f2937 100%)', emoji: '🐆', name: 'Leopard', baseRarity: 'epic' },
            { gradient: 'linear-gradient(135deg, #78350f 0%, #57534e 50%, #44403c 100%)', emoji: '🦣', name: 'Mammoth', baseRarity: 'epic' },
            // New Collectables - Legendary (2)
            { gradient: 'linear-gradient(135deg, #dc2626 0%, #f97316 50%, #fbbf24 100%)', emoji: '🐉', name: 'Dragon', baseRarity: 'legendary' },
            { gradient: 'linear-gradient(135deg, #10b981 0%, #059669 50%, #fbbf24 100%)', emoji: '🐍', name: 'Basilisk', baseRarity: 'legendary' },
            // New Collectables - Mythical (2)
            { gradient: 'linear-gradient(135deg, #fbbf24 0%, #dc2626 50%, #7c2d12 100%)', emoji: '🐲', name: 'Chinese Dragon', baseRarity: 'mythical' },
            { gradient: 'linear-gradient(135deg, #ff6b00 0%, #fbbf24 50%, #fef3c7 100%)', emoji: '🕊️', name: 'Phoenix', baseRarity: 'mythical' },
            // New Collectables - Common (4)
            { gradient: 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 50%, #6ee7b7 100%)', emoji: '🦎', name: 'Gecko', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #fef3c7 0%, #fde68a 50%, #fcd34d 100%)', emoji: '🐕', name: 'Dog', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #d1d5db 0%, #9ca3af 50%, #6b7280 100%)', emoji: '🐈‍⬛', name: 'Black Cat', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #fed7aa 0%, #fdba74 50%, #fb923c 100%)', emoji: '🦭', name: 'Harbor Seal', baseRarity: 'common' },
            // New Collectables - Uncommon (3)
            { gradient: 'linear-gradient(135deg, #bae6fd 0%, #7dd3fc 50%, #38bdf8 100%)', emoji: '🪿', name: 'Wild Goose', baseRarity: 'uncommon' },
            { gradient: 'linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 50%, #d1d5db 100%)', emoji: '🐅', name: 'Frost Tiger', baseRarity: 'uncommon' },
            { gradient: 'linear-gradient(135deg, #d9f99d 0%, #bef264 50%, #a3e635 100%)', emoji: '🍄', name: 'Forest Sprite', baseRarity: 'uncommon' },
            // New Collectables - Rare (2)
            { gradient: 'linear-gradient(135deg, #fca5a5 0%, #f87171 50%, #ef4444 100%)', emoji: '🦂', name: 'Fire Scorpion', baseRarity: 'rare' },
            { gradient: 'linear-gradient(135deg, #9ca3af 0%, #6b7280 50%, #4b5563 100%)', emoji: '🐕‍🦺', name: 'Shadow Wolf', baseRarity: 'rare' },
            // New Collectables - Epic (1)
            { gradient: 'linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%)', emoji: '🐐', name: 'Manticore', baseRarity: 'epic' },
            // New Collectables - Legendary (1)
            { gradient: 'linear-gradient(135deg, #fef3c7 0%, #fde047 50%, #facc15 100%)', emoji: '🐏', name: 'Star Stag', baseRarity: 'legendary' },
            // New Collectables - Exotic (1)
            { gradient: 'linear-gradient(135deg, #2BEFFF 0%, #0ea5e9 50%, #0284c7 100%)', emoji: '🌌', name: 'Cosmic Whale', baseRarity: 'exotic' },
            // New Collectables - Secret (1)
            { gradient: 'linear-gradient(135deg, #454545 0%, #374151 50%, #1f2937 100%)', emoji: '🌟', name: 'Celestial Spirit', baseRarity: 'secret' },
            // Jewelry & Precious Items - Common (8)
            { gradient: 'linear-gradient(135deg, #fef3c7 0%, #fde68a 50%, #fcd34d 100%)', emoji: '💍', name: 'Gold Ring', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 50%, #a5b4fc 100%)', emoji: '💎', name: 'Crystal', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #fef9c3 0%, #fef08a 50%, #fde047 100%)', emoji: '🪙', name: 'Gold Coin', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #d1d5db 0%, #9ca3af 50%, #6b7280 100%)', emoji: '⚜️', name: 'Silver Brooch', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #fed7aa 0%, #fdba74 50%, #fb923c 100%)', emoji: '🔶', name: 'Amber Stone', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #fecaca 0%, #fca5a5 50%, #f87171 100%)', emoji: '💝', name: 'Ruby Heart', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 50%, #a78bfa 100%)', emoji: '🔮', name: 'Amethyst Orb', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 50%, #6ee7b7 100%)', emoji: '💚', name: 'Jade Pendant', baseRarity: 'common' },
            // Jewelry & Precious Items - Uncommon (6)
            { gradient: 'linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%)', emoji: '👑', name: 'Bronze Crown', baseRarity: 'uncommon' },
            { gradient: 'linear-gradient(135deg, #bae6fd 0%, #7dd3fc 50%, #38bdf8 100%)', emoji: '💙', name: 'Sapphire', baseRarity: 'uncommon' },
            { gradient: 'linear-gradient(135deg, #fbcfe8 0%, #f9a8d4 50%, #f472b6 100%)', emoji: '🌸', name: 'Pearl Flower', baseRarity: 'uncommon' },
            { gradient: 'linear-gradient(135deg, #fde68a 0%, #fbbf24 50%, #f59e0b 100%)', emoji: '🏺', name: 'Golden Vase', baseRarity: 'uncommon' },
            { gradient: 'linear-gradient(135deg, #ccfbf1 0%, #99f6e4 50%, #5eead4 100%)', emoji: '💠', name: 'Turquoise Gem', baseRarity: 'uncommon' },
            { gradient: 'linear-gradient(135deg, #e0e7ff 0%, #a5b4fc 50%, #818cf8 100%)', emoji: '📿', name: 'Diamond Beads', baseRarity: 'uncommon' },
            // Jewelry & Precious Items - Rare (4)
            { gradient: 'linear-gradient(135deg, #fef3c7 0%, #fde047 50%, #facc15 100%)', emoji: '🌟', name: 'Star Diamond', baseRarity: 'rare' },
            { gradient: 'linear-gradient(135deg, #fca5a5 0%, #f87171 50%, #ef4444 100%)', emoji: '❤️', name: 'Ruby Heart Gem', baseRarity: 'rare' },
            { gradient: 'linear-gradient(135deg, #d1fae5 0%, #6ee7b7 50%, #10b981 100%)', emoji: '🟢', name: 'Emerald', baseRarity: 'rare' },
            { gradient: 'linear-gradient(135deg, #fed7aa 0%, #fb923c 50%, #f97316 100%)', emoji: '🧿', name: 'Evil Eye Amulet', baseRarity: 'rare' },
            // Jewelry & Precious Items - Epic (2)
            { gradient: 'linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #1f2937 100%)', emoji: '💰', name: 'Treasure Chest', baseRarity: 'epic' },
            { gradient: 'linear-gradient(135deg, #fef3c7 0%, #fde047 50%, #dc2626 100%)', emoji: '👸', name: 'Royal Tiara', baseRarity: 'epic' },
            // Jewelry & Precious Items - Legendary (2)
            { gradient: 'linear-gradient(135deg, #fef3c7 0%, #fde047 50%, #fbbf24 100%)', emoji: '🔱', name: 'Golden Trident', baseRarity: 'legendary' },
            { gradient: 'linear-gradient(135deg, #ff6b00 0%, #fbbf24 50%, #fef3c7 100%)', emoji: '🪶', name: 'Phoenix Feather', baseRarity: 'legendary' }
        ];
        
        const rarityColors = {
            common: '#f3f4f6',
            uncommon: '#d1fae5',
            rare: '#dbeafe',
            epic: '#e9d5ff',
            legendary: '#fef3c7',
            mythical: 'linear-gradient(135deg, #AB0E0E 0%, #DC2626 50%, #EF4444 100%)',
            exotic: '#2BEFFF',
            secret: '#454545',
            boss: 'linear-gradient(135deg, #3d0a2e 0%, #4a0e3a 50%, #5a1045 100%)'
        };

        const rarityLabels = {
            common: 'Common',
            uncommon: 'Uncommon',
            rare: 'Rare',
            epic: 'Epic',
            legendary: 'Legendary',
            mythical: 'Mythical',
            exotic: 'Exotic',
            secret: 'Secret',
            boss: 'Boss'
        };
        
        function getHighestLevel() {
            try {
                const saved = localStorage.getItem('mathGameHighestLevel');
                return saved ? parseInt(saved) : 1;
            } catch (e) {
                return 1;
            }
        }
        
        function saveHighestLevel(level) {
            try {
                const current = getHighestLevel();
                if (level > current) {
                    localStorage.setItem('mathGameHighestLevel', level.toString());
                }
            } catch (e) {
                console.error('Error saving highest level:', e);
            }
        }
        
        function determineRarity(highestLevel) {
            let probabilities = {
                common: 60,
                uncommon: 25,
                rare: 10,
                epic: 4,
                legendary: 1,
                mythical: 0.5,
                exotic: 0.35,
                secret: 0.1
            };

            if (highestLevel > 1) {
                const levelBonus = (highestLevel - 1) * 2;
                const reduction = levelBonus / 2;

                probabilities.common = Math.max(30, probabilities.common - reduction);
                probabilities.uncommon = Math.max(15, probabilities.uncommon - reduction);
                probabilities.rare += levelBonus * 0.5;
                probabilities.epic += levelBonus * 0.3;
                probabilities.legendary += levelBonus * 0.2;
                probabilities.mythical += levelBonus * 0.1;
                probabilities.exotic += levelBonus * 0.05;
                probabilities.secret += levelBonus * 0.02;
            }

            const random = Math.random() * 100;
            let cumulative = 0;

            for (const [rarity, probability] of Object.entries(probabilities)) {
                cumulative += probability;
                if (random < cumulative) {
                    return rarity;
                }
            }

            return 'common';
        }
        
        let currentLevel = 1;
        let currentBg = null;
        let cells = {};
        let currentQuestion = null;
        let cellsDiscovered = 0;
        let totalMistakes = 0;
        let mistakeLog = {};
        let slowLog = {};
        let fastLog = {};
        let allTimesLog = {};
        let level1MistakeLog = {};
        let level1SlowLog = {};
        let level4MistakeLog = {};
        let level4SlowLog = {};
        let practiceQuestions = [];
        // Pathfinding-specific state (Level 3)
        let pathfindingTiles = {};
        let avatarPosition = null;
        let chestPosition = null;
        let selectedTile = null;
        let questionsSinceLastMistake = 0;
        let pendingRetry = null;
        let questionStartTime = null;
        let timerInterval = null;
        let audioContext = null;
        let isPaused = false;
        let isCheckingAnswer = false;
        let lastAnswerSubmitTime = 0;
        let pausedTime = 0;
        let bossPosition = 50;
        let bossMovementInterval = null;
        let bossStartTime = null;
        let useSingleAdd = true;
        let backgroundMusicInterval = null;
        let backgroundMusicOscillators = [];
        
        function saveCollection(collection) {
            try {
                localStorage.setItem('mathGameCollection', JSON.stringify(collection));
            } catch (e) {
                console.error('Error saving collection:', e);
            }
        }
        
        function loadCollection() {
            try {
                const saved = localStorage.getItem('mathGameCollection');
                if (saved) {
                    return JSON.parse(saved);
                }
            } catch (e) {
                console.error('Error loading collection:', e);
            }
            return [];
        }
        
        function addToCollection(emoji, name) {
            const collection = loadCollection();
            const existing = collection.find(item => item.emoji === emoji);
            
            if (existing) {
                existing.count = (existing.count || 1) + 1;
                existing.lastFound = new Date().toISOString();
            } else {
                const animal = backgrounds.find(bg => bg.emoji === emoji);
                const rarity = animal ? animal.baseRarity : 'common';
                
                const newItem = { 
                    emoji, 
                    name, 
                    rarity, 
                    count: 1,
                    firstFound: new Date().toISOString(),
                    lastFound: new Date().toISOString()
                };
                collection.push(newItem);
            }
            
            saveCollection(collection);
            updateCollectionCount();
        }
        
        function removeFromCollection(emoji) {
            if (!testMode) return;
            const collection = loadCollection();
            const item = collection.find(c => c.emoji === emoji);
            
            if (item) {
                if ((item.count || 1) > 1) {
                    item.count--;
                } else {
                    const index = collection.indexOf(item);
                    collection.splice(index, 1);
                }
                saveCollection(collection);
                updateCollectionCount();
                viewCollection();
            }
        }
        
        function updateCollectionCount() {
            const collection = loadCollection();
            const totalCount = collection.reduce((sum, item) => sum + (item.count || 1), 0);
            document.getElementById('collection-count').textContent = `📚 Collection: ${totalCount}`;
            updateCollectiblesPane();
        }
        
        function updateCollectiblesPane() {
            const collection = loadCollection();
            const paneGrid = document.getElementById('collectibles-pane-grid');
            paneGrid.innerHTML = '';

            if (collection.length === 0) {
                paneGrid.innerHTML = '<div class="collectible-empty">Complete games to collect animals! 🎯</div>';
            } else {
                collection.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'collectible-item';
                    div.innerHTML = item.emoji;
                    div.title = `${item.name} - ${rarityLabels[item.rarity || 'common']} (x${item.count || 1})`;
                    const bgColor = rarityColors[item.rarity || 'common'];
                    if (bgColor.startsWith('linear-gradient')) {
                        div.style.background = bgColor;
                    } else {
                        div.style.backgroundColor = bgColor;
                    }
                    div.onclick = () => viewCollection();

                    if ((item.count || 1) > 1) {
                        const badge = document.createElement('div');
                        badge.className = 'collectible-count-badge';
                        badge.textContent = item.count || 1;
                        div.appendChild(badge);
                    }

                    paneGrid.appendChild(div);
                });
            }
        }
        
        function viewCollection() {
            const collection = loadCollection();
            const grid = document.getElementById('collection-grid');
            grid.innerHTML = '';

            if (collection.length === 0) {
                grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #9ca3af; font-size: 1.2rem;">No collectibles yet! Complete games to collect cute animals! 🎯</p>';
            } else {
                collection.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'collection-item';
                    const bgColor = rarityColors[item.rarity || 'common'];
                    if (bgColor.startsWith('linear-gradient')) {
                        div.style.background = bgColor;
                    } else {
                        div.style.backgroundColor = bgColor;
                    }

                    const emoji = document.createElement('div');
                    emoji.textContent = item.emoji;
                    div.appendChild(emoji);

                    const tooltip = document.createElement('div');
                    tooltip.className = 'collection-item-tooltip';
                    tooltip.textContent = `${rarityLabels[item.rarity || 'common']} - Found ${item.count || 1}x`;
                    div.appendChild(tooltip);

                    if ((item.count || 1) > 1) {
                        const badge = document.createElement('div');
                        badge.className = 'collectible-count-badge';
                        badge.textContent = item.count || 1;
                        div.appendChild(badge);
                    }

                    if (testMode) {
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'delete-collectible';
                        deleteBtn.textContent = '×';
                        deleteBtn.onclick = (e) => {
                            e.stopPropagation();
                            if (confirm(`Remove ${item.name} from collection?`)) {
                                removeFromCollection(item.emoji);
                            }
                        };
                        div.appendChild(deleteBtn);
                    }

                    grid.appendChild(div);
                });
            }

            document.getElementById('collection-modal').classList.add('visible');
        }
        
        function closeCollection() {
            document.getElementById('collection-modal').classList.remove('visible');
        }
        
        function selectRandomBackground() {
            const highestLevel = getHighestLevel();
            const targetRarity = determineRarity(highestLevel);

            const matchingRarity = backgrounds.filter(bg => bg.baseRarity === targetRarity);

            if (matchingRarity.length > 0) {
                return matchingRarity[Math.floor(Math.random() * matchingRarity.length)];
            } else {
                return backgrounds[Math.floor(Math.random() * backgrounds.length)];
            }
        }

        function selectRandomJewelryBackground() {
            // Filter for jewelry collectibles (the ones we just added)
            const jewelryBackgrounds = backgrounds.filter(bg =>
                bg.name.includes('Ring') || bg.name.includes('Crystal') || bg.name.includes('Coin') ||
                bg.name.includes('Brooch') || bg.name.includes('Amber') || bg.name.includes('Ruby') ||
                bg.name.includes('Amethyst') || bg.name.includes('Jade') || bg.name.includes('Crown') ||
                bg.name.includes('Sapphire') || bg.name.includes('Pearl') || bg.name.includes('Vase') ||
                bg.name.includes('Turquoise') || bg.name.includes('Diamond') || bg.name.includes('Emerald') ||
                bg.name.includes('Amulet') || bg.name.includes('Treasure') || bg.name.includes('Tiara') ||
                bg.name.includes('Trident') || bg.name.includes('Feather') || bg.name.includes('Heart')
            );

            const highestLevel = getHighestLevel();
            const targetRarity = determineRarity(highestLevel);

            const matchingRarity = jewelryBackgrounds.filter(bg => bg.baseRarity === targetRarity);

            if (matchingRarity.length > 0) {
                return matchingRarity[Math.floor(Math.random() * matchingRarity.length)];
            } else if (jewelryBackgrounds.length > 0) {
                return jewelryBackgrounds[Math.floor(Math.random() * jewelryBackgrounds.length)];
            } else {
                return backgrounds[0]; // Fallback
            }
        }
        
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }
        
        function playSound(frequency, duration, type = 'sine', delay = 0) {
            initAudio();
            if (!audioContext) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = type;
            
            const startTime = audioContext.currentTime + delay;
            gainNode.gain.setValueAtTime(0.3, startTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + duration);
            
            oscillator.start(startTime);
            oscillator.stop(startTime + duration);
        }
        
        function playSuccessSound() {
            playSound(523.25, 0.1, 'sine', 0);
            playSound(659.25, 0.1, 'sine', 0.1);
            playSound(783.99, 0.2, 'sine', 0.2);
        }
        
        function playCellRevealSound() {
            playSound(523.25, 0.15, 'sine', 0);
            playSound(659.25, 0.15, 'sine', 0.08);
            playSound(783.99, 0.15, 'sine', 0.16);
            playSound(1046.50, 0.3, 'sine', 0.24);
        }
        
        function playFailSound() {
            playSound(392, 0.15, 'sine', 0);
            playSound(349.23, 0.3, 'sine', 0.15);
        }
        
        function playCompletionSound() {
            playSound(523.25, 0.2, 'sine', 0);
            playSound(659.25, 0.2, 'sine', 0.15);
            playSound(783.99, 0.2, 'sine', 0.3);
            playSound(1046.50, 0.25, 'sine', 0.45);
            playSound(783.99, 0.2, 'sine', 0.7);
            playSound(1046.50, 0.25, 'sine', 0.85);
            playSound(1318.51, 0.3, 'sine', 1.0);
            playSound(1046.50, 0.2, 'sine', 1.3);
            playSound(1318.51, 0.4, 'sine', 1.45);
            playSound(1567.98, 0.6, 'sine', 1.7);
        }

        function playBossVictorySound() {
            initAudio();
            if (!audioContext) return;

            const notes = [
                { freq: 196, delay: 0, duration: 0.3 },
                { freq: 261.63, delay: 0.35, duration: 0.3 },
                { freq: 329.63, delay: 0.7, duration: 0.3 },
                { freq: 392, delay: 1.05, duration: 0.5 },
                { freq: 329.63, delay: 1.6, duration: 0.3 },
                { freq: 392, delay: 1.95, duration: 0.6 }
            ];

            notes.forEach(note => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = note.freq;
                oscillator.type = 'sawtooth';

                const startTime = audioContext.currentTime + note.delay;
                gainNode.gain.setValueAtTime(0.4, startTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + note.duration);

                oscillator.start(startTime);
                oscillator.stop(startTime + note.duration);
            });
        }

        function startBackgroundMusic() {
            if (!audioContext) initAudio();
            if (!audioContext) return;

            stopBackgroundMusic();

            const playNote = (frequency, duration) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = frequency;
                oscillator.type = 'triangle';

                gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);

                return oscillator;
            };

            let currentNote = 0;
            const notes = [130.81, 98];
            const playNextNote = () => {
                if (!backgroundMusicInterval) return;
                playNote(notes[currentNote], 0.4);
                currentNote = (currentNote + 1) % 2;
            };

            playNextNote();
            backgroundMusicInterval = setInterval(playNextNote, 1000);
        }

        function updateBackgroundMusicSpeed() {
            if (!backgroundMusicInterval) return;

            const distanceFromPlayer = bossPosition - 10;
            const maxDistance = 80;
            const minInterval = 200;
            const maxInterval = 1000;

            const interval = minInterval + ((distanceFromPlayer / maxDistance) * (maxInterval - minInterval));

            clearInterval(backgroundMusicInterval);

            let currentNote = 0;
            const notes = [130.81, 98];
            const playNextNote = () => {
                if (!backgroundMusicInterval) return;
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = notes[currentNote];
                oscillator.type = 'triangle';

                gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.4);

                currentNote = (currentNote + 1) % 2;
            };

            playNextNote();
            backgroundMusicInterval = setInterval(playNextNote, Math.max(minInterval, interval));
        }

        function stopBackgroundMusic() {
            if (backgroundMusicInterval) {
                clearInterval(backgroundMusicInterval);
                backgroundMusicInterval = null;
            }
            backgroundMusicOscillators.forEach(osc => {
                try { osc.stop(); } catch (e) {}
            });
            backgroundMusicOscillators = [];
        }
        
        function updateTimer() {
            if (!questionStartTime || isPaused) return;
            const elapsed = Math.floor((Date.now() - questionStartTime - pausedTime) / 1000);
            document.getElementById('timer').textContent = `${elapsed}s`;
        }
        
        function startTimer() {
            questionStartTime = Date.now();
            pausedTime = 0;
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(updateTimer, 1000);
            updateTimer();
        }
        
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            return questionStartTime ? Math.floor((Date.now() - questionStartTime - pausedTime) / 1000) : 0;
        }
        
        function togglePause() {
            isPaused = !isPaused;
            const overlay = document.getElementById('paused-overlay');
            const pauseButton = document.getElementById('pause-button');
            
            if (isPaused) {
                overlay.classList.add('visible');
                pauseButton.textContent = '▶️ Resume';
                const pauseStart = Date.now();
                pauseButton.dataset.pauseStart = pauseStart;
            } else {
                overlay.classList.remove('visible');
                pauseButton.textContent = '⏸️ Pause';
                const pauseDuration = Date.now() - parseInt(pauseButton.dataset.pauseStart);
                pausedTime += pauseDuration;
                updateTimer();
            }
        }
        
        function createCrackSVG() {
            let color = '#8b5cf6';
            if (currentLevel === 2) color = '#f59e0b';
            if (currentLevel === 3) color = '#14b8a6'; // Teal for pathfinding
            if (currentLevel === 4) color = '#10b981';
            if (currentLevel === 5) color = '#6366f1';
            if (currentLevel === 6) color = '#dc2626';
            
            return `<svg width="62.5" height="62.5" xmlns="http://www.w3.org/2000/svg">
                <path d="M 10 0 L 15 20 L 25 15 L 30 35 L 40 30" 
                      stroke="${color}" stroke-width="2" fill="none" opacity="0.8"/>
                <path d="M 30 0 L 35 25 L 45 20 L 50 40" 
                      stroke="${color}" stroke-width="2" fill="none" opacity="0.8"/>
                <path d="M 0 20 L 20 25 L 15 40 L 30 45" 
                      stroke="${color}" stroke-width="2" fill="none" opacity="0.8"/>
                <path d="M 20 50 L 30 55 L 40 50 L 50 62.5" 
                      stroke="${color}" stroke-width="2" fill="none" opacity="0.8"/>
            </svg>`;
        }
        
        function createGrid() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';

            for (let rowIndex = 0; rowIndex < GRID_SIZE; rowIndex++) {
                const row = rowIndex + GRID_OFFSET;
                const rowDiv = document.createElement('div');
                rowDiv.className = 'grid-row';

                for (let colIndex = 0; colIndex < GRID_SIZE; colIndex++) {
                    const col = colIndex + GRID_OFFSET;
                    const cellKey = `${row}-${col}`;

                    const cellDiv = document.createElement('div');
                    cellDiv.className = 'grid-cell';
                    cellDiv.id = cellKey;

                    const coverDiv = document.createElement('div');
                    coverDiv.className = 'cell-cover';
                    coverDiv.id = `${cellKey}-cover`;

                    const cracksDiv = document.createElement('div');
                    cracksDiv.className = 'cell-cracks';
                    cracksDiv.id = `${cellKey}-cracks`;
                    cracksDiv.innerHTML = createCrackSVG();

                    cellDiv.appendChild(coverDiv);
                    cellDiv.appendChild(cracksDiv);
                    rowDiv.appendChild(cellDiv);
                }

                grid.appendChild(rowDiv);
            }
        }

        function createPathfindingGrid() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';

            for (let row = 0; row < PATHFINDING_GRID_SIZE; row++) {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'grid-row';

                for (let col = 0; col < PATHFINDING_GRID_SIZE; col++) {
                    const cellKey = `${row}-${col}`;
                    const tileData = pathfindingTiles[cellKey];

                    const cellDiv = document.createElement('div');
                    cellDiv.className = 'pathfinding-cell';
                    cellDiv.id = cellKey;
                    cellDiv.setAttribute('data-row', row);
                    cellDiv.setAttribute('data-col', col);

                    // Add click handler
                    cellDiv.addEventListener('click', () => handlePathfindingTileClick(row, col));

                    // Add avatar if this is avatar position
                    if (row === avatarPosition.row && col === avatarPosition.col) {
                        cellDiv.innerHTML = '<div class="avatar">🧙</div>';
                        cellDiv.classList.add('has-avatar');
                    }

                    // Add chest if this is chest position
                    if (row === chestPosition.row && col === chestPosition.col) {
                        cellDiv.innerHTML = '<div class="chest">🎁</div>';
                        cellDiv.classList.add('has-chest');
                    }

                    // Apply tile state class
                    cellDiv.classList.add(`tile-${tileData.state}`);

                    rowDiv.appendChild(cellDiv);
                }

                grid.appendChild(rowDiv);
            }

            // Highlight adjacent tiles
            updatePathfindingHighlights();
        }

        function updatePathfindingHighlights() {
            // Remove all highlights
            const allCells = document.querySelectorAll('.pathfinding-cell');
            allCells.forEach(cell => cell.classList.remove('adjacent', 'movable'));

            // Highlight tiles adjacent to avatar (for questioning)
            const adjacentPositions = [
                { row: avatarPosition.row - 1, col: avatarPosition.col },
                { row: avatarPosition.row + 1, col: avatarPosition.col },
                { row: avatarPosition.row, col: avatarPosition.col - 1 },
                { row: avatarPosition.row, col: avatarPosition.col + 1 }
            ];

            adjacentPositions.forEach(pos => {
                if (pos.row >= 0 && pos.row < PATHFINDING_GRID_SIZE &&
                    pos.col >= 0 && pos.col < PATHFINDING_GRID_SIZE) {
                    const key = `${pos.row}-${pos.col}`;
                    const tile = pathfindingTiles[key];
                    const cellDiv = document.getElementById(key);

                    if (tile.state === 'covered' && cellDiv) {
                        cellDiv.classList.add('adjacent');
                    }
                }
            });

            // Highlight paved tiles (for movement)
            for (let key in pathfindingTiles) {
                const tile = pathfindingTiles[key];
                if (tile.state === 'paved') {
                    const cellDiv = document.getElementById(key);
                    if (cellDiv && key !== `${avatarPosition.row}-${avatarPosition.col}`) {
                        cellDiv.classList.add('movable');
                    }
                }
            }
        }

        function handlePathfindingTileClick(row, col) {
            const key = `${row}-${col}`;
            const tile = pathfindingTiles[key];

            // Check if clicking on chest at the right position
            if (row === chestPosition.row && col === chestPosition.col &&
                row === avatarPosition.row && col === avatarPosition.col) {
                openTreasureChest();
                return;
            }

            // Check if clicking on a paved tile (movement)
            if (tile.state === 'paved' &&
                (row !== avatarPosition.row || col !== avatarPosition.col)) {
                moveAvatarTo(row, col);
                return;
            }

            // Check if clicking on an adjacent covered tile (questioning)
            const isAdjacent = Math.abs(row - avatarPosition.row) + Math.abs(col - avatarPosition.col) === 1;

            if (isAdjacent && tile.state === 'covered' && !tile.questioned) {
                selectedTile = { row, col };
                showPathfindingQuestion();
            }
        }

        function moveAvatarTo(row, col) {
            // Remove avatar from current position
            const oldKey = `${avatarPosition.row}-${avatarPosition.col}`;
            const oldCell = document.getElementById(oldKey);
            if (oldCell) {
                oldCell.classList.remove('has-avatar');
                oldCell.innerHTML = '';
            }

            // Update avatar position
            avatarPosition = { row, col };

            // Add avatar to new position
            const newKey = `${row}-${col}`;
            const newCell = document.getElementById(newKey);
            if (newCell) {
                newCell.classList.add('has-avatar');
                if (row === chestPosition.row && col === chestPosition.col) {
                    // Avatar is on the chest
                    newCell.innerHTML = '<div class="avatar">🧙</div><div class="chest">🎁</div>';
                } else {
                    newCell.innerHTML = '<div class="avatar">🧙</div>';
                }
            }

            // Update highlights
            updatePathfindingHighlights();

            // Check if avatar reached chest
            if (row === chestPosition.row && col === chestPosition.col) {
                setTimeout(() => {
                    openTreasureChest();
                }, 500);
            }
        }

        function showPathfindingQuestion() {
            // Generate a random question
            const levelConfig = LEVEL_CONFIG[currentLevel];
            const questionType = QUESTION_TYPES[levelConfig.questionType];

            const [rowMin, rowMax] = questionType.rowRange;
            const [colMin, colMax] = questionType.colRange;

            const row = Math.floor(Math.random() * (rowMax - rowMin + 1)) + rowMin;
            const col = Math.floor(Math.random() * (colMax - colMin + 1)) + colMin;
            const answer = questionType.operationFn(row, col);

            currentQuestion = { row, col, answer };
            questionStartTime = Date.now();
            pausedTime = 0;

            document.getElementById('question').textContent = `${row} ${questionType.operationSymbol} ${col}`;
            document.getElementById('answer-input').value = '';
            document.getElementById('answer-input').focus();

            startTimer();
        }

        function openTreasureChest() {
            playCompletionSound();

            document.getElementById('game-board').style.display = 'none';

            const completionText = document.getElementById('completion-text');
            completionText.textContent = `You found the ${currentBg.name}!`;

            const newCollectibleDiv = document.getElementById('new-collectible');
            newCollectibleDiv.textContent = currentBg.emoji;

            addToCollection(currentBg.emoji, currentBg.name);

            document.getElementById('completion').style.display = 'flex';
        }

        function updateCell(cellKey) {
            const cell = cells[cellKey];
            const coverDiv = document.getElementById(`${cellKey}-cover`);
            const cracksDiv = document.getElementById(`${cellKey}-cracks`);
            
            if (coverDiv && cracksDiv) {
                if (cell.correctAnswers === 0) {
                    coverDiv.style.opacity = '1';
                    cracksDiv.style.opacity = '0';
                } else if (cell.correctAnswers === 1) {
                    coverDiv.style.opacity = '0.7';
                    cracksDiv.style.opacity = '1';
                } else {
                    coverDiv.style.opacity = '0';
                    cracksDiv.style.opacity = '0';
                }
            }
        }
        
        function initializeLevel() {
            cells = {};
            
            for (let row = GRID_OFFSET; row < GRID_SIZE + GRID_OFFSET; row++) {
                for (let col = GRID_OFFSET; col < GRID_SIZE + GRID_OFFSET; col++) {
                    cells[`${row}-${col}`] = { correctAnswers: 0, completed: false };
                }
            }
            cellsDiscovered = 0;
            
            totalMistakes = 0;
            mistakeLog = {};
            slowLog = {};
            fastLog = {};

            const levelConfig = LEVEL_CONFIG[currentLevel];
            const practiceType = PRACTICE_TYPES[levelConfig.practiceType];

            if (practiceType.questionSource === 'random') {
                allTimesLog = {};
            }
            questionsSinceLastMistake = 0;
            pendingRetry = null;

            document.getElementById('progress-text').textContent = `${cellsDiscovered}/64 Cells Discovered!`;
            document.getElementById('mistakes-text').textContent = 'Mistakes: 0';
        }

        function initializePathfindingLevel() {
            pathfindingTiles = {};

            // Initialize all tiles as covered
            for (let row = 0; row < PATHFINDING_GRID_SIZE; row++) {
                for (let col = 0; col < PATHFINDING_GRID_SIZE; col++) {
                    const key = `${row}-${col}`;
                    pathfindingTiles[key] = { state: 'covered', questioned: false };
                }
            }

            // Set avatar position (middle left)
            const avatarRow = Math.floor(PATHFINDING_GRID_SIZE / 2); // Row 4 (middle)
            const avatarCol = 0; // Leftmost column
            avatarPosition = { row: avatarRow, col: avatarCol };
            pathfindingTiles[`${avatarRow}-${avatarCol}`].state = 'paved';

            // Set chest position (middle right)
            const chestRow = Math.floor(PATHFINDING_GRID_SIZE / 2); // Row 4 (middle)
            const chestCol = PATHFINDING_GRID_SIZE - 1; // Rightmost column
            chestPosition = { row: chestRow, col: chestCol };

            selectedTile = null;
            totalMistakes = 0;
            cellsDiscovered = 0;

            document.getElementById('progress-text').textContent = 'Find the treasure!';
            document.getElementById('mistakes-text').textContent = 'Mistakes: 0';
        }

        function showLevelIntro() {
            const intro = document.getElementById('level-intro');
            const title = document.getElementById('level-intro-title');
            const desc = document.getElementById('level-intro-desc');
            const bossIntroEmoji = document.getElementById('boss-intro-emoji');

            const levelConfig = LEVEL_CONFIG[currentLevel];

            document.body.className = '';
            if (levelConfig.theme === 'orange') document.body.classList.add('level-2');
            if (levelConfig.theme === 'teal') document.body.classList.add('level-3');
            if (levelConfig.theme === 'green') document.body.classList.add('level-4');
            if (levelConfig.theme === 'indigo') document.body.classList.add('level-5');
            if (levelConfig.theme === 'red') document.body.classList.add('level-6');

            if (currentLevel === 6) {
                bossIntroEmoji.style.display = 'block';
            } else {
                bossIntroEmoji.style.display = 'none';
            }

            title.textContent = levelConfig.title;

            const description = typeof levelConfig.description === 'function'
                ? levelConfig.description(practiceQuestions.length)
                : levelConfig.description;
            desc.textContent = description;

            document.getElementById('level-badge').textContent = `Level ${currentLevel}`;
            intro.classList.add('visible');
        }
        
        function startLevel() {
            document.getElementById('level-intro').classList.remove('visible');

            const levelConfig = LEVEL_CONFIG[currentLevel];
            const isBossLevel = levelConfig.practiceType === 'C';
            const isPathfindingLevel = levelConfig.practiceType === 'D';

            if (isBossLevel) {
                document.getElementById('game-board').style.display = 'none';
                document.getElementById('boss-arena').style.display = 'block';
                initializeBossBattle();
            } else if (isPathfindingLevel) {
                document.getElementById('game-board').style.display = 'block';
                document.getElementById('boss-arena').style.display = 'none';
                currentBg = selectRandomJewelryBackground();
                document.getElementById('background').style.background = currentBg.gradient;
                document.getElementById('emoji').textContent = currentBg.emoji;

                initializePathfindingLevel();
                createPathfindingGrid();

                // Don't generate question yet, wait for tile click
            } else {
                document.getElementById('game-board').style.display = 'block';
                document.getElementById('boss-arena').style.display = 'none';
                currentBg = selectRandomBackground();
                document.getElementById('background').style.background = currentBg.gradient;
                document.getElementById('emoji').textContent = currentBg.emoji;

                initializeLevel();
                createGrid();

                generateQuestion();
            }

            if (!isPathfindingLevel && !isBossLevel) {
                generateQuestion();
            }
        }

        function initializeBossBattle() {
            bossPosition = 50;
            totalMistakes = 0;
            useSingleAdd = true;
            document.getElementById('mistakes-text').textContent = 'Mistakes: 0';

            const bossChar = document.getElementById('boss-character');
            bossChar.style.left = bossPosition + '%';
            updateBossProgressBar();

            if (bossMovementInterval) clearInterval(bossMovementInterval);
            bossStartTime = Date.now();

            startBackgroundMusic();

            bossMovementInterval = setInterval(() => {
                if (!isPaused) {
                    moveBossTowardsPlayer();
                }
            }, 1000);
        }

        function moveBossTowardsPlayer() {
            const movePerSecond = 40 / 40;
            bossPosition -= movePerSecond;

            if (bossPosition <= 10) {
                bossPosition = 10;
                clearInterval(bossMovementInterval);
                stopBackgroundMusic();
                loseBossBattle();
                return;
            }

            const bossChar = document.getElementById('boss-character');
            bossChar.style.left = bossPosition + '%';
            updateBossProgressBar();

            const distanceFromPlayer = bossPosition - 10;
            if (distanceFromPlayer < 15) {
                document.getElementById('boss-danger-zone').textContent = '⚠️ DANGER! Boss is getting close! ⚠️';
            } else {
                document.getElementById('boss-danger-zone').textContent = '';
            }

            updateBackgroundMusicSpeed();
        }

        function moveBossAway() {
            const moveDistance = (100 / 15) * 1.5;
            bossPosition += moveDistance;

            if (bossPosition >= 90) {
                bossPosition = 90;
                clearInterval(bossMovementInterval);
                stopBackgroundMusic();
                winBossBattle();
                return;
            }

            const bossChar = document.getElementById('boss-character');
            bossChar.style.left = bossPosition + '%';
            updateBossProgressBar();

            document.getElementById('boss-danger-zone').textContent = '';
            updateBackgroundMusicSpeed();
        }

        function updateBossProgressBar() {
            const progressFill = document.getElementById('boss-progress-fill');
            const progressPercent = ((bossPosition - 10) / (90 - 10)) * 100;
            progressFill.style.width = progressPercent + '%';

            if (bossPosition >= 90) {
                progressFill.textContent = '🎉 Victory! 🎉';
            } else if (bossPosition <= 10) {
                progressFill.textContent = '💀 Defeated 💀';
            } else {
                progressFill.textContent = `Boss at ${Math.round(bossPosition)}%`;
            }
        }

        function throwBombAtBoss() {
            const bomb = document.getElementById('boss-bomb');
            const explosion = document.getElementById('boss-explosion');
            const bossChar = document.getElementById('boss-character');
            const avatar = document.getElementById('boss-avatar');

            bomb.style.left = '10%';
            bomb.style.bottom = '140px';
            bomb.style.opacity = '1';

            const bossLeft = bossPosition;
            bomb.style.animation = 'none';
            setTimeout(() => {
                bomb.style.animation = `throwBall 0.8s ease-out`;
                bomb.style.left = bossLeft + '%';
            }, 10);

            avatar.classList.add('celebrating');

            setTimeout(() => {
                bomb.style.opacity = '0';
                explosion.style.left = bossLeft + '%';
                explosion.style.bottom = '140px';
                explosion.style.opacity = '1';
                explosion.style.transform = 'scale(1)';
                bossChar.classList.add('angry');

                playSound(100, 0.3, 'sawtooth', 0);

                setTimeout(() => {
                    explosion.style.opacity = '0';
                    explosion.style.transform = 'scale(0)';
                    bomb.style.animation = 'none';
                    bossChar.classList.remove('angry');
                    avatar.classList.remove('celebrating');
                }, 400);
            }, 700);
        }

        function throwBombMiss() {
            const bomb = document.getElementById('boss-bomb');
            const avatar = document.getElementById('boss-avatar');

            bomb.style.left = '10%';
            bomb.style.bottom = '140px';
            bomb.style.opacity = '1';

            const missLeft = Math.min(bossPosition - 15, 35);
            bomb.style.animation = 'none';
            setTimeout(() => {
                bomb.style.animation = `throwBall 0.8s ease-out`;
                bomb.style.left = missLeft + '%';
            }, 10);

            setTimeout(() => {
                bomb.style.opacity = '0';
                bomb.style.animation = 'none';
            }, 800);
        }

        function winBossBattle() {
            stopTimer();
            if (bossMovementInterval) clearInterval(bossMovementInterval);
            playBossVictorySound();

            saveHighestLevel(currentLevel);

            const collection = loadCollection();
            const existing = collection.find(item => item.emoji === '👹');

            if (existing) {
                existing.count = (existing.count || 1) + 1;
                existing.lastFound = new Date().toISOString();
            } else {
                const newItem = {
                    emoji: '👹',
                    name: 'Boss',
                    rarity: 'boss',
                    count: 1,
                    firstFound: new Date().toISOString(),
                    lastFound: new Date().toISOString()
                };
                collection.push(newItem);
            }

            saveCollection(collection);
            updateCollectionCount();

            document.getElementById('question-box').style.display = 'none';
            document.getElementById('completion').style.display = 'block';
            document.getElementById('completion-text').textContent = 'You defeated the Boss!';
            document.getElementById('new-collectible').textContent = '👹';

            const nextLevelBtn = document.getElementById('next-level-button');
            nextLevelBtn.style.display = 'none';

            const reportsContainer = document.getElementById('reports-container');
            let reportsHTML = '<div class="achievement-report"><h3>🎉 Boss Defeated! 🎉</h3>';
            reportsHTML += `<p>You captured the boss in the prison!</p>`;
            if (totalMistakes === 0) {
                reportsHTML += '<p>🌟 Perfect Victory - No Mistakes!</p>';
            } else {
                reportsHTML += `<p>Mistakes: ${totalMistakes}</p>`;
            }
            reportsHTML += '</div>';
            reportsContainer.innerHTML = reportsHTML;
        }

        function loseBossBattle() {
            stopTimer();
            if (bossMovementInterval) clearInterval(bossMovementInterval);
            stopBackgroundMusic();
            playFailSound();

            setTimeout(() => {
                document.getElementById('boss-loss-modal').style.display = 'flex';
            }, 500);
        }

        function restartFromBossLoss() {
            document.getElementById('boss-loss-modal').style.display = 'none';
            restartGame();
        }

        function generateRandomQuestionFromType(questionType) {
            const qType = QUESTION_TYPES[questionType];
            const [rowMin, rowMax] = qType.rowRange;
            const [colMin, colMax] = qType.colRange;

            const row = Math.floor(Math.random() * (rowMax - rowMin + 1)) + rowMin;
            const col = Math.floor(Math.random() * (colMax - colMin + 1)) + colMin;
            const answer = qType.operationFn(row, col);

            return { row, col, answer };
        }

        function generateQuestion() {
            const levelConfig = LEVEL_CONFIG[currentLevel];
            const practiceType = PRACTICE_TYPES[levelConfig.practiceType];

            if (practiceType.questionSource === 'mixed') {
                const questionTypeKey = useSingleAdd ? 'single-add' : 'double-add';
                useSingleAdd = !useSingleAdd;

                currentQuestion = generateRandomQuestionFromType(questionTypeKey);
                const questionType = QUESTION_TYPES[questionTypeKey];

                document.getElementById('question').textContent = `What is ${currentQuestion.row} ${questionType.operationSymbol} ${currentQuestion.col}?`;
                document.getElementById('answer-input').value = '';
                document.getElementById('feedback').textContent = '';

                // Re-enable input for new question
                isCheckingAnswer = false;
                document.getElementById('answer-input').disabled = false;
                document.getElementById('answer-input').focus();
                startTimer();
                return;
            }

            const questionType = QUESTION_TYPES[levelConfig.questionType];

            const allRevealed = Object.values(cells).every(cell => cell.correctAnswers >= 2);
            if (allRevealed) {
                showCompletion();
                return;
            }

            if (practiceType.questionSource === 'random') {
                if (pendingRetry && questionsSinceLastMistake >= 2) {
                    currentQuestion = pendingRetry;
                    pendingRetry = null;
                    questionsSinceLastMistake = 0;
                } else {
                    currentQuestion = generateRandomQuestionFromType(levelConfig.questionType);
                }
            } else if (practiceType.questionSource === 'practice-set') {
                if (practiceQuestions.length === 0) {
                    showCompletion();
                    return;
                }

                const randomQ = practiceQuestions[Math.floor(Math.random() * practiceQuestions.length)];
                const answer = questionType.operationFn(randomQ.row, randomQ.col);
                currentQuestion = { row: randomQ.row, col: randomQ.col, answer: answer };
            }

            document.getElementById('question').textContent = `What is ${currentQuestion.row} ${questionType.operationSymbol} ${currentQuestion.col}?`;
            document.getElementById('answer-input').value = '';
            document.getElementById('feedback').textContent = '';

            // Re-enable input for new question
            isCheckingAnswer = false;
            document.getElementById('answer-input').disabled = false;
            document.getElementById('answer-input').focus();
            startTimer();
        }
        
        function checkAnswer() {
            // Prevent multiple rapid submissions with timestamp check (300ms debounce)
            const now = Date.now();
            if (isPaused || isCheckingAnswer || (now - lastAnswerSubmitTime) < 300) return;

            initAudio();
            const answerInput = document.getElementById('answer-input');
            const userAnswer = parseInt(answerInput.value);
            if (!currentQuestion || isNaN(userAnswer)) return;

            // Prevent multiple submissions and clear input immediately
            isCheckingAnswer = true;
            lastAnswerSubmitTime = now;
            answerInput.disabled = true;
            answerInput.value = '';

            const levelConfig = LEVEL_CONFIG[currentLevel];
            const practiceType = PRACTICE_TYPES[levelConfig.practiceType];
            const isBossLevel = practiceType.questionSource === 'mixed';
            const isPathfindingLevel = levelConfig.practiceType === 'D';

            const timeSpent = stopTimer();
            const isCorrect = userAnswer === currentQuestion.answer;
            const feedbackDiv = document.getElementById('feedback');

            if (isPathfindingLevel) {
                const tileKey = `${selectedTile.row}-${selectedTile.col}`;
                const tile = pathfindingTiles[tileKey];

                if (isCorrect) {
                    feedbackDiv.textContent = '✨ Correct! Path opened!';
                    feedbackDiv.className = 'feedback correct';
                    playSuccessSound();

                    // Mark tile as paved
                    tile.state = 'paved';
                    tile.questioned = true;

                    const cellDiv = document.getElementById(tileKey);
                    if (cellDiv) {
                        cellDiv.classList.remove('tile-covered', 'adjacent');
                        cellDiv.classList.add('tile-paved');
                    }

                    // Move avatar to the newly paved tile
                    setTimeout(() => {
                        moveAvatarTo(selectedTile.row, selectedTile.col);
                        isCheckingAnswer = false;
                        answerInput.disabled = false;
                    }, 800);
                } else {
                    feedbackDiv.textContent = '❌ Wrong! Tile blocked!';
                    feedbackDiv.className = 'feedback incorrect';
                    playFailSound();

                    // Mark tile as permanently blocked
                    tile.state = 'blocked';
                    tile.questioned = true;

                    const cellDiv = document.getElementById(tileKey);
                    if (cellDiv) {
                        cellDiv.classList.remove('tile-covered', 'adjacent');
                        cellDiv.classList.add('tile-blocked');
                    }

                    totalMistakes++;
                    document.getElementById('mistakes-text').textContent = `Mistakes: ${totalMistakes}`;

                    setTimeout(() => {
                        updatePathfindingHighlights();
                        isCheckingAnswer = false;
                        answerInput.disabled = false;
                    }, 1000);
                }

                return;
            }

            if (isBossLevel) {
                if (isCorrect) {
                    feedbackDiv.textContent = '✨ Correct! Great job!';
                    feedbackDiv.className = 'feedback correct';
                    playSuccessSound();

                    throwBombAtBoss();
                    setTimeout(() => {
                        moveBossAway();
                    }, 400);

                    setTimeout(generateQuestion, 1200);
                } else {
                    feedbackDiv.textContent = '🤔 Not quite! Try again!';
                    feedbackDiv.className = 'feedback incorrect';
                    playFailSound();

                    throwBombMiss();

                    totalMistakes++;
                    document.getElementById('mistakes-text').textContent = `Mistakes: ${totalMistakes}`;

                    setTimeout(() => {
                        // Re-enable input for retry
                        isCheckingAnswer = false;
                        document.getElementById('answer-input').disabled = false;
                        document.getElementById('answer-input').focus();
                        startTimer();
                    }, 1000);
                }
                return;
            }

            const questionType = QUESTION_TYPES[levelConfig.questionType];

            if (isCorrect) {
                feedbackDiv.textContent = '✨ Correct! Great job!';
                feedbackDiv.className = 'feedback correct';

                const canProgress = Object.keys(cells).filter(key => cells[key].correctAnswers < 2);

                if (canProgress.length === 0) {
                    playSuccessSound();
                    setTimeout(() => {
                        showCompletion();
                    }, 1000);
                    return;
                }

                const cellsPerAnswer = typeof practiceType.cellsPerAnswer === 'function'
                    ? practiceType.cellsPerAnswer(practiceQuestions.length)
                    : practiceType.cellsPerAnswer;

                const shuffled = canProgress.sort(() => Math.random() - 0.5);
                const numToProgress = Math.min(cellsPerAnswer, canProgress.length);

                let newlyCompleted = 0;
                for (let i = 0; i < numToProgress; i++) {
                    const cellKey = shuffled[i];
                    cells[cellKey].correctAnswers++;

                    if (cells[cellKey].correctAnswers >= 2) {
                        cells[cellKey].completed = true;
                        cellsDiscovered++;
                        newlyCompleted++;
                    }

                    updateCell(cellKey);
                }

                if (newlyCompleted > 0) {
                    playCellRevealSound();
                } else {
                    playSuccessSound();
                }

                document.getElementById('progress-text').textContent = `${cellsDiscovered}/64 Cells Discovered!`;

                const questionKey = `${currentQuestion.row}${questionType.operationSymbol}${currentQuestion.col}`;

                if (practiceType.questionSource === 'random') {
                    if (!allTimesLog[questionKey]) allTimesLog[questionKey] = [];
                    allTimesLog[questionKey].push(timeSpent);
                }

                if (timeSpent < 5) {
                    if (!fastLog[questionKey]) fastLog[questionKey] = [];
                    fastLog[questionKey].push(timeSpent);
                }

                if (timeSpent >= 20) {
                    if (!slowLog[questionKey]) slowLog[questionKey] = [];
                    slowLog[questionKey].push(timeSpent);
                }

                if (practiceType.requiresRetry) {
                    questionsSinceLastMistake++;
                }

                setTimeout(generateQuestion, 1000);
            } else {
                feedbackDiv.textContent = '🤔 Not quite! Try again!';
                feedbackDiv.className = 'feedback incorrect';

                playFailSound();

                totalMistakes++;
                document.getElementById('mistakes-text').textContent = `Mistakes: ${totalMistakes}`;

                const questionKey = `${currentQuestion.row}${questionType.operationSymbol}${currentQuestion.col}`;
                if (!mistakeLog[questionKey]) mistakeLog[questionKey] = 0;
                mistakeLog[questionKey]++;

                if (practiceType.requiresRetry) {
                    if (!pendingRetry || (pendingRetry.row !== currentQuestion.row || pendingRetry.col !== currentQuestion.col)) {
                        pendingRetry = { row: currentQuestion.row, col: currentQuestion.col, answer: currentQuestion.answer };
                        questionsSinceLastMistake = 0;
                    }
                }

                const cellsPerAnswer = typeof practiceType.cellsPerAnswer === 'function'
                    ? practiceType.cellsPerAnswer(practiceQuestions.length)
                    : practiceType.cellsPerAnswer;

                const canRegress = Object.keys(cells).filter(key => cells[key].correctAnswers > 0);

                if (canRegress.length > 0) {
                    const shuffled = canRegress.sort(() => Math.random() - 0.5);
                    const numToRegress = Math.min(cellsPerAnswer, canRegress.length);

                    for (let i = 0; i < numToRegress; i++) {
                        const cellKey = shuffled[i];

                        if (cells[cellKey].correctAnswers === 2) {
                            cells[cellKey].completed = false;
                            cellsDiscovered--;
                        }

                        cells[cellKey].correctAnswers = Math.max(0, cells[cellKey].correctAnswers - 1);
                        updateCell(cellKey);
                    }
                }

                document.getElementById('progress-text').textContent = `${cellsDiscovered}/64 Cells Discovered!`;

                // Re-enable input for retry
                isCheckingAnswer = false;
                document.getElementById('answer-input').disabled = false;
                document.getElementById('answer-input').focus();

                startTimer();
            }
        }
        
        function revealAll() {
            if (!confirm('This will complete all remaining cells and end the game. Continue?')) {
                return;
            }

            stopBackgroundMusic();
            if (bossMovementInterval) clearInterval(bossMovementInterval);

            for (let key in cells) {
                if (!cells[key].completed) {
                    cells[key].correctAnswers = 2;
                    cells[key].completed = true;
                    updateCell(key);
                }
            }

            cellsDiscovered = 64;
            document.getElementById('progress-text').textContent = '64/64 Cells Discovered!';
            showCompletion();
        }

        function generatePracticeQuestions(sourceLevel) {
            const sourceLevelConfig = LEVEL_CONFIG[sourceLevel];
            const targetLevel = sourceLevel + 1;
            const targetLevelConfig = LEVEL_CONFIG[targetLevel];
            const practiceType = PRACTICE_TYPES[targetLevelConfig.practiceType];
            const questionType = QUESTION_TYPES[sourceLevelConfig.questionType];

            const mistakeLogVar = sourceLevel === 1 ? level1MistakeLog : level4MistakeLog;
            const slowLogVar = sourceLevel === 1 ? level1SlowLog : level4SlowLog;

            const questions = [];
            const questionSet = new Set();

            const operationSymbol = questionType.operationSymbol;

            for (const questionKey in mistakeLogVar) {
                const [row, col] = questionKey.split(operationSymbol).map(Number);
                const key = `${row}-${col}`;
                if (!questionSet.has(key)) {
                    questions.push({ row, col });
                    questionSet.add(key);
                }
            }

            for (const questionKey in slowLogVar) {
                const [row, col] = questionKey.split(operationSymbol).map(Number);
                const key = `${row}-${col}`;
                if (!questionSet.has(key)) {
                    questions.push({ row, col });
                    questionSet.add(key);
                }
            }

            if (questions.length < practiceType.minQuestions) {
                const avgTimes = [];
                for (const questionKey in allTimesLog) {
                    const times = allTimesLog[questionKey];
                    const avgTime = times.reduce((sum, t) => sum + t, 0) / times.length;
                    const [row, col] = questionKey.split(operationSymbol).map(Number);
                    const key = `${row}-${col}`;

                    if (!questionSet.has(key)) {
                        avgTimes.push({ row, col, avgTime, key });
                    }
                }

                avgTimes.sort((a, b) => b.avgTime - a.avgTime);

                const needed = practiceType.minQuestions - questions.length;
                for (let i = 0; i < Math.min(needed, avgTimes.length); i++) {
                    questions.push({ row: avgTimes[i].row, col: avgTimes[i].col });
                    questionSet.add(avgTimes[i].key);
                }
            }

            return questions;
        }

        function showCompletion() {
            stopTimer();
            playCompletionSound();

            saveHighestLevel(currentLevel);

            addToCollection(currentBg.emoji, currentBg.name);

            const levelConfig = LEVEL_CONFIG[currentLevel];

            if (levelConfig.sourceLevel === null) {
                if (currentLevel === 1) {
                    level1MistakeLog = { ...mistakeLog };
                    level1SlowLog = { ...slowLog };
                } else if (currentLevel === 4) {
                    level4MistakeLog = { ...mistakeLog };
                    level4SlowLog = { ...slowLog };
                }

                const nextLevel = currentLevel + 1;
                if (LEVEL_CONFIG[nextLevel]) {
                    practiceQuestions = generatePracticeQuestions(currentLevel);
                }
            }
            
            document.getElementById('question-box').style.display = 'none';
            document.getElementById('completion').style.display = 'block';
            document.getElementById('completion-text').textContent = `You revealed the ${currentBg.name}!`;
            document.getElementById('new-collectible').textContent = currentBg.emoji;
            
            const nextLevelBtn = document.getElementById('next-level-button');
            const nextLevel = currentLevel + 1;
            if (LEVEL_CONFIG[nextLevel] && (levelConfig.sourceLevel === null ? practiceQuestions.length > 0 : true)) {
                nextLevelBtn.style.display = 'inline-block';
            } else {
                nextLevelBtn.style.display = 'none';
            }
            
            const reportsContainer = document.getElementById('reports-container');
            let reportsHTML = '';
            
            if (Object.keys(fastLog).length > 0) {
                reportsHTML += '<div class="achievement-report"><h3>🌟 Speed Achievements (Under 5 seconds):</h3><ul>';
                const sortedFast = Object.entries(fastLog).sort((a, b) => {
                    const avgA = a[1].reduce((sum, t) => sum + t, 0) / a[1].length;
                    const avgB = b[1].reduce((sum, t) => sum + t, 0) / b[1].length;
                    return avgA - avgB;
                });
                for (const [question, times] of sortedFast) {
                    const avgTime = (times.reduce((sum, t) => sum + t, 0) / times.length).toFixed(1);
                    reportsHTML += `<li>${question} (${avgTime}s avg)</li>`;
                }
                reportsHTML += '</ul></div>';
            }
            
            if (totalMistakes > 0) {
                reportsHTML += '<div class="mistake-report"><h3>Questions with Mistakes:</h3><ul>';
                const sortedMistakes = Object.entries(mistakeLog).sort((a, b) => b[1] - a[1]);
                for (const [question, count] of sortedMistakes) {
                    reportsHTML += `<li>${question} (${count} mistake${count > 1 ? 's' : ''})</li>`;
                }
                reportsHTML += '</ul></div>';
            }
            
            if (Object.keys(slowLog).length > 0) {
                reportsHTML += '<div class="mistake-report"><h3>Questions That Took Time (20+ seconds):</h3><ul>';
                const sortedSlow = Object.entries(slowLog).sort((a, b) => {
                    const avgA = a[1].reduce((sum, t) => sum + t, 0) / a[1].length;
                    const avgB = b[1].reduce((sum, t) => sum + t, 0) / b[1].length;
                    return avgB - avgA;
                });
                for (const [question, times] of sortedSlow) {
                    const avgTime = Math.round(times.reduce((sum, t) => sum + t, 0) / times.length);
                    reportsHTML += `<li>${question} (avg ${avgTime}s)</li>`;
                }
                reportsHTML += '</ul></div>';
            }
            
            if (totalMistakes === 0 && Object.keys(slowLog).length === 0 && Object.keys(fastLog).length === 0) {
                reportsHTML = '<div class="achievement-report"><h3>Perfect! 🌟</h3></div>';
            }
            
            reportsContainer.innerHTML = reportsHTML;
        }
        
        function goToNextLevel() {
            const nextLevel = currentLevel + 1;
            if (LEVEL_CONFIG[nextLevel]) {
                currentLevel = nextLevel;
            }

            stopBackgroundMusic();
            if (bossMovementInterval) clearInterval(bossMovementInterval);

            document.getElementById('completion').style.display = 'none';
            document.getElementById('question-box').style.display = 'block';
            showLevelIntro();
        }
        
        document.getElementById('answer-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                // Prevent multiple rapid submissions
                if (isCheckingAnswer || isPaused) {
                    e.preventDefault();
                    return;
                }
                e.preventDefault();
                checkAnswer();
            }
        });

        // Panic button: Press R to toggle test panel visibility instantly (test mode only)
        document.addEventListener('keydown', function(e) {
            if ((e.key === 'r' || e.key === 'R') && testMode) {
                const testPanel = document.getElementById('test-panel');
                testPanel.classList.toggle('visible');
            }
        });

        function restartGame() {
            if (confirm('Are you sure you want to restart this level? Your current progress will be lost.')) {
                stopTimer();
                if (bossMovementInterval) clearInterval(bossMovementInterval);
                stopBackgroundMusic();
                isPaused = false;
                document.getElementById('paused-overlay').classList.remove('visible');
                document.getElementById('pause-button').textContent = '⏸️ Pause';

                document.getElementById('completion').style.display = 'none';
                document.getElementById('question-box').style.display = 'block';

                showLevelIntro();
            }
        }
        
        function jumpToLevel(level) {
            if (!testMode) return;

            const resetSelector = () => {
                document.getElementById('level-selector').value = currentLevel;
            };

            if (level === 2 || level === 4) {
                if (level === 2 && (!level1MistakeLog || Object.keys(level1MistakeLog).length === 0)) {
                    alert('Level 2 requires completing Level 1 first to generate practice questions.');
                    resetSelector();
                    return;
                }
                if (level === 5 && (!level4MistakeLog || Object.keys(level4MistakeLog).length === 0)) {
                    alert('Level 5 requires completing Level 4 first to generate practice questions.');
                    resetSelector();
                    return;
                }
            }

            stopTimer();
            if (bossMovementInterval) clearInterval(bossMovementInterval);
            stopBackgroundMusic();
            isPaused = false;
            document.getElementById('paused-overlay').classList.remove('visible');
            document.getElementById('pause-button').textContent = '⏸️ Pause';

            document.getElementById('completion').style.display = 'none';
            document.getElementById('question-box').style.display = 'block';

            currentLevel = level;
            showLevelIntro();
        }

        function populateCollectibleSelector() {
            if (!testMode) return;

            const selector = document.getElementById('collectible-selector');
            if (!selector) return;

            const sortedAnimals = [...backgrounds].sort((a, b) => a.name.localeCompare(b.name));

            sortedAnimals.forEach(animal => {
                const option = document.createElement('option');
                option.value = animal.emoji;
                option.textContent = `${animal.emoji} ${animal.name} (${rarityLabels[animal.baseRarity]})`;
                selector.appendChild(option);
            });
        }

        function addTestCollectible() {
            if (!testMode) return;

            const selector = document.getElementById('collectible-selector');
            if (!selector || !selector.value) return;

            const selectedEmoji = selector.value;
            const animal = backgrounds.find(bg => bg.emoji === selectedEmoji);

            if (animal) {
                addToCollection(animal.emoji, animal.name);

                const collectionBadge = document.getElementById('collection-count');
                collectionBadge.style.transform = 'scale(1.2)';
                collectionBadge.style.transition = 'transform 0.2s';
                setTimeout(() => {
                    collectionBadge.style.transform = 'scale(1)';
                }, 200);
            }
        }

        updateCollectionCount();
        showLevelIntro();
        createGrid();
        populateCollectibleSelector();
    </script>
</body>
</html>
