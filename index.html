<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Picture Reveal Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Comic Sans MS', cursive;
            background: linear-gradient(135deg, #fce7f3 0%, #f3e8ff 50%, #dbeafe 100%);
            min-height: 100vh;
            padding: 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        body.level-2 {
            background: linear-gradient(135deg, #fef3c7 0%, #fed7aa 50%, #fbbf24 100%);
        }
        
        body.level-3 {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 50%, #6ee7b7 100%);
        }
        
        body.level-4 {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 50%, #a5b4fc 100%);
        }
        
        .container {
            max-width: 1400px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .main-content {
            display: flex;
            gap: 2rem;
            align-items: flex-start;
            width: 100%;
            justify-content: center;
        }
        
        .collectibles-pane {
            display: none;
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            border: 4px solid #e9d5ff;
            box-shadow: 0 20px 25px rgba(0,0,0,0.15);
            width: 180px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        body.level-2 .collectibles-pane {
            border-color: #fbbf24;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            box-shadow: 0 20px 25px rgba(251, 191, 36, 0.2);
        }
        
        body.level-3 .collectibles-pane {
            border-color: #10b981;
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            box-shadow: 0 20px 25px rgba(16, 185, 129, 0.2);
        }
        
        body.level-4 .collectibles-pane {
            border-color: #6366f1;
            background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
            box-shadow: 0 20px 25px rgba(99, 102, 241, 0.2);
        }
        
        .collectibles-pane h3 {
            color: #9333ea;
            font-size: 1.3rem;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        body.level-2 .collectibles-pane h3 {
            color: #f59e0b;
        }
        
        body.level-3 .collectibles-pane h3 {
            color: #059669;
        }
        
        body.level-4 .collectibles-pane h3 {
            color: #4f46e5;
        }
        
        .collectibles-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            max-height: 420px;
            overflow-y: auto;
        }
        
        .collectible-item {
            background: #f3f4f6;
            border-radius: 0.5rem;
            padding: 0.5rem;
            text-align: center;
            font-size: 2rem;
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
        }
        
        .collectible-item:hover {
            transform: scale(1.1);
        }
        
        .collectible-count-badge {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .collectible-empty {
            text-align: center;
            color: #9ca3af;
            font-size: 0.9rem;
            padding: 1rem;
            grid-column: 1 / -1;
        }
        
        @media (min-width: 1200px) {
            .collectibles-pane {
                display: block;
            }
        }
        
        .level-intro {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
            animation: fadeIn 0.5s;
        }
        
        .level-intro.visible {
            display: flex;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .level-intro-content {
            background: white;
            border-radius: 2rem;
            padding: 3rem;
            text-align: center;
            box-shadow: 0 30px 60px rgba(0,0,0,0.3);
            animation: scaleIn 0.5s;
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.8); }
            to { transform: scale(1); }
        }
        
        .level-intro h1 {
            font-size: 4rem;
            background: linear-gradient(135deg, #9333ea 0%, #ec4899 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
        }
        
        body.level-2 .level-intro h1 {
            background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        body.level-3 .level-intro h1 {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        body.level-4 .level-intro h1 {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .level-intro p {
            font-size: 1.5rem;
            color: #6b7280;
            margin-bottom: 2rem;
        }
        
        .start-level-button {
            background: linear-gradient(135deg, #c084fc 0%, #f9a8d4 100%);
            color: white;
            font-family: 'Comic Sans MS', cursive;
            font-size: 2rem;
            font-weight: bold;
            padding: 1rem 3rem;
            border-radius: 9999px;
            border: none;
            cursor: pointer;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }
        
        body.level-2 .start-level-button {
            background: linear-gradient(135deg, #fbbf24 0%, #f97316 100%);
        }
        
        body.level-3 .start-level-button {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        body.level-4 .start-level-button {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        }
        
        .start-level-button:hover {
            transform: scale(1.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        h1 {
            color: #9333ea;
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        
        body.level-2 h1 {
            color: #f59e0b;
        }
        
        body.level-3 h1 {
            color: #059669;
        }
        
        body.level-4 h1 {
            color: #4f46e5;
        }
        
        .level-badge {
            display: inline-block;
            background: linear-gradient(135deg, #c084fc 0%, #f9a8d4 100%);
            color: white;
            padding: 0.5rem 1.5rem;
            border-radius: 9999px;
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 1rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        body.level-2 .level-badge {
            background: linear-gradient(135deg, #fbbf24 0%, #f97316 100%);
        }
        
        body.level-3 .level-badge {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        body.level-4 .level-badge {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        }
        
        .progress-bar {
            display: flex;
            gap: 1rem;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .progress {
            background: white;
            border-radius: 9999px;
            padding: 0.5rem 1.5rem;
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
        }
        
        .progress p {
            color: #a855f7;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        body.level-2 .progress p {
            color: #f59e0b;
        }
        
        body.level-3 .progress p {
            color: #059669;
        }
        
        body.level-4 .progress p {
            color: #4f46e5;
        }
        
        .mistakes {
            background: white;
            border-radius: 9999px;
            padding: 0.5rem 1.5rem;
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
        }
        
        .mistakes p {
            color: #f59e0b;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .collection-badge {
            background: white;
            border-radius: 9999px;
            padding: 0.5rem 1.5rem;
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .collection-badge:hover {
            transform: scale(1.05);
        }
        
        .collection-badge p {
            color: #8b5cf6;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .restart-button, .pause-button {
            background: #ef4444;
            color: white;
            font-weight: bold;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            border: none;
            cursor: pointer;
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
            font-size: 1rem;
        }
        
        .pause-button {
            background: #f59e0b;
        }
        
        .restart-button:hover {
            background: #dc2626;
        }
        
        .pause-button:hover {
            background: #d97706;
        }

        .game-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }

        .game-board {
            position: relative;
            width: 500px;
            height: 500px;
        }
        
        .background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #ffc0cb 0%, #e9d5ff 50%, #bfdbfe 100%);
            border-radius: 0.5rem;
            box-shadow: 0 20px 25px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        body.level-2 .background {
            box-shadow: 0 20px 25px rgba(251, 191, 36, 0.3);
            border: 4px solid #fbbf24;
        }
        
        body.level-3 .background {
            box-shadow: 0 20px 25px rgba(16, 185, 129, 0.3);
            border: 4px solid #10b981;
        }
        
        body.level-4 .background {
            box-shadow: 0 20px 25px rgba(99, 102, 241, 0.3);
            border: 4px solid #6366f1;
        }
        
        .emoji {
            font-size: 400px;
            line-height: 500px;
        }
        
        .grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 0.5rem;
            overflow: hidden;
            pointer-events: none;
        }
        
        .grid-row {
            display: flex;
            height: 62.5px;
        }
        
        .grid-cell {
            position: relative;
            width: 62.5px;
            height: 62.5px;
            border: 2px solid #9333ea;
            box-sizing: border-box;
            overflow: hidden;
        }
        
        body.level-2 .grid-cell {
            border-color: #f59e0b;
        }
        
        body.level-3 .grid-cell {
            border-color: #10b981;
        }
        
        body.level-4 .grid-cell {
            border-color: #6366f1;
        }
        
        .cell-cover {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 192, 203, 1);
            transition: opacity 0.5s ease;
        }
        
        body.level-2 .cell-cover {
            background-color: rgba(251, 191, 36, 1);
        }
        
        body.level-3 .cell-cover {
            background-color: rgba(16, 185, 129, 1);
        }
        
        body.level-4 .cell-cover {
            background-color: rgba(99, 102, 241, 1);
        }
        
        .cell-cracks {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        .question-box {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            border: 4px solid #e9d5ff;
            box-shadow: 0 20px 25px rgba(0,0,0,0.15);
            width: 400px;
            text-align: center;
            position: relative;
        }
        
        body.level-2 .question-box {
            border-color: #fbbf24;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            box-shadow: 0 20px 25px rgba(251, 191, 36, 0.2);
        }
        
        body.level-3 .question-box {
            border-color: #10b981;
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            box-shadow: 0 20px 25px rgba(16, 185, 129, 0.2);
        }
        
        body.level-4 .question-box {
            border-color: #6366f1;
            background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
            box-shadow: 0 20px 25px rgba(99, 102, 241, 0.2);
        }
        
        .paused-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 1rem;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        
        .paused-overlay.visible {
            display: flex;
        }
        
        .paused-text {
            font-size: 2rem;
            color: #9333ea;
            font-weight: bold;
        }
        
        body.level-2 .paused-text {
            color: #f59e0b;
        }
        
        body.level-3 .paused-text {
            color: #059669;
        }
        
        body.level-4 .paused-text {
            color: #4f46e5;
        }
        
        .timer {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 0.9rem;
            font-weight: bold;
            color: #9333ea;
            opacity: 0.6;
        }
        
        body.level-2 .timer {
            color: #f59e0b;
        }
        
        body.level-3 .timer {
            color: #059669;
        }
        
        body.level-4 .timer {
            color: #4f46e5;
        }
        
        .question {
            color: #9333ea;
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
        }
        
        body.level-2 .question {
            color: #f59e0b;
        }
        
        body.level-3 .question {
            color: #059669;
        }
        
        body.level-4 .question {
            color: #4f46e5;
        }
        
        .answer-input {
            font-family: 'Comic Sans MS', cursive;
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            width: 130px;
            padding: 0.75rem 1rem;
            border: 4px solid #d8b4fe;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
        }
        
        body.level-2 .answer-input {
            border-color: #fbbf24;
        }
        
        body.level-3 .answer-input {
            border-color: #10b981;
        }
        
        body.level-4 .answer-input {
            border-color: #6366f1;
        }
        
        .answer-input:focus {
            outline: none;
            border-color: #9333ea;
        }
        
        body.level-2 .answer-input:focus {
            border-color: #f59e0b;
        }
        
        body.level-3 .answer-input:focus {
            border-color: #059669;
        }
        
        body.level-4 .answer-input:focus {
            border-color: #4f46e5;
        }
        
        .check-button {
            background: linear-gradient(135deg, #c084fc 0%, #f9a8d4 100%);
            color: white;
            font-family: 'Comic Sans MS', cursive;
            font-size: 1.5rem;
            font-weight: bold;
            padding: 0.75rem 2rem;
            border-radius: 9999px;
            border: none;
            cursor: pointer;
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        
        body.level-2 .check-button {
            background: linear-gradient(135deg, #fbbf24 0%, #f97316 100%);
        }
        
        body.level-3 .check-button {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        body.level-4 .check-button {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        }
        
        .check-button:hover {
            background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%);
            transform: scale(1.05);
        }
        
        body.level-2 .check-button:hover {
            background: linear-gradient(135deg, #f59e0b 0%, #dc2626 100%);
        }
        
        body.level-3 .check-button:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }
        
        body.level-4 .check-button:hover {
            background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%);
        }
        
        .feedback {
            font-size: 1.5rem;
            font-weight: bold;
            margin-top: 1rem;
        }
        
        .feedback.correct {
            color: #10b981;
        }
        
        .feedback.incorrect {
            color: #f59e0b;
        }
        
        .completion {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            border: 4px solid #e9d5ff;
            box-shadow: 0 20px 25px rgba(0,0,0,0.15);
            width: 500px;
            text-align: center;
        }
        
        body.level-2 .completion {
            border-color: #fbbf24;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            box-shadow: 0 20px 25px rgba(251, 191, 36, 0.2);
        }
        
        body.level-3 .completion {
            border-color: #10b981;
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            box-shadow: 0 20px 25px rgba(16, 185, 129, 0.2);
        }
        
        body.level-4 .completion {
            border-color: #6366f1;
            background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
            box-shadow: 0 20px 25px rgba(99, 102, 241, 0.2);
        }
        
        .completion h2 {
            color: #9333ea;
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        
        body.level-2 .completion h2 {
            color: #f59e0b;
        }
        
        body.level-3 .completion h2 {
            color: #059669;
        }
        
        body.level-4 .completion h2 {
            color: #4f46e5;
        }
        
        .completion p {
            color: #a855f7;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }
        
        body.level-2 .completion p {
            color: #f59e0b;
        }
        
        body.level-3 .completion p {
            color: #059669;
        }
        
        body.level-4 .completion p {
            color: #4f46e5;
        }
        
        .new-collectible {
            font-size: 5rem;
            margin: 1rem 0;
            animation: bounce 1s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        
        .next-level-button {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            font-family: 'Comic Sans MS', cursive;
            font-size: 1.5rem;
            font-weight: bold;
            padding: 1rem 2rem;
            border-radius: 9999px;
            border: none;
            cursor: pointer;
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
            margin-top: 1rem;
            transition: all 0.3s;
        }
        
        .next-level-button:hover {
            transform: scale(1.05);
        }
        
        .mistake-report, .achievement-report {
            margin-top: 1.5rem;
            padding: 1rem;
            background: #fef3c7;
            border-radius: 0.5rem;
            text-align: left;
        }
        
        .achievement-report {
            background: #d1fae5;
        }
        
        .mistake-report h3, .achievement-report h3 {
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
        }
        
        .mistake-report h3 {
            color: #f59e0b;
        }
        
        .achievement-report h3 {
            color: #059669;
        }
        
        .mistake-report ul, .achievement-report ul {
            list-style: none;
            font-size: 1.1rem;
        }
        
        .mistake-report ul {
            color: #92400e;
        }
        
        .achievement-report ul {
            color: #065f46;
        }
        
        .mistake-report li, .achievement-report li {
            margin: 0.3rem 0;
        }
        
        .collection-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        
        .collection-modal.visible {
            display: flex;
        }
        
        .collection-content {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        
        .collection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .collection-header h2 {
            color: #9333ea;
            font-size: 2rem;
        }
        
        .close-button {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .collection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 1rem;
        }
        
        .collection-item {
            background: #f3f4f6;
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
            font-size: 3rem;
            position: relative;
            cursor: help;
        }
        
        .collection-item-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            margin-bottom: 0.5rem;
            z-index: 10;
        }
        
        .collection-item:hover .collection-item-tooltip {
            opacity: 1;
        }
        
        .delete-collectible {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 1rem;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            z-index: 20;
        }
        
        .collection-item:hover .delete-collectible {
            display: flex;
        }
        
        .test-panel {
            position: fixed;
            top: 1rem;
            left: 1rem;
            background: #fee;
            border: 2px solid #f00;
            padding: 1rem;
            border-radius: 0.5rem;
            display: none;
            z-index: 50;
        }
        
        .test-panel.visible {
            display: block;
        }
        
        .test-panel h3 {
            color: #f00;
            margin-bottom: 0.5rem;
        }
        
        .test-button {
            background: #f00;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.25rem;
            cursor: pointer;
            font-weight: bold;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .version-info {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background: rgba(255, 255, 255, 0.8);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            color: #6b7280;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="version-info">v2.0.0</div>
    
    <div class="test-panel" id="test-panel">
        <h3>üîß Test Panel</h3>
        <button class="test-button" onclick="revealAll()">Reveal All & End</button>
        <button class="test-button" onclick="viewCollection()">View Collection</button>
        <div style="margin-top: 0.5rem;">
            <label style="color: #f00; font-weight: bold; margin-right: 0.5rem;">Jump to:</label>
            <select id="level-selector" onchange="jumpToLevel(parseInt(this.value))" style="padding: 0.5rem; border-radius: 0.25rem; border: 1px solid #f00; font-family: 'Comic Sans MS', cursive; font-weight: bold;">
                <option value="1">Level 1</option>
                <option value="2">Level 2</option>
                <option value="3">Level 3</option>
                <option value="4">Level 4</option>
            </select>
        </div>
    </div>

    <div class="level-intro" id="level-intro">
        <div class="level-intro-content">
            <h1 id="level-intro-title">LEVEL 1</h1>
            <p id="level-intro-desc">Practice Addition!</p>
            <button class="start-level-button" onclick="startLevel()">START</button>
        </div>
    </div>

    <div class="collection-modal" id="collection-modal">
        <div class="collection-content">
            <div class="collection-header">
                <h2>üé® My Collection</h2>
                <button class="close-button" onclick="closeCollection()">√ó</button>
            </div>
            <div class="collection-grid" id="collection-grid"></div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="level-badge" id="level-badge">Level 1</div>
            <h1>Math Picture Reveal! ‚ú®</h1>
            <div class="progress-bar">
                <div class="progress">
                    <p id="progress-text">0/64 Cells Discovered!</p>
                </div>
                <div class="mistakes">
                    <p id="mistakes-text">Mistakes: 0</p>
                </div>
                <div class="collection-badge" onclick="viewCollection()">
                    <p id="collection-count">üìö Collection: 0</p>
                </div>
                <button class="pause-button" id="pause-button" onclick="togglePause()">‚è∏Ô∏è Pause</button>
                <button class="restart-button" onclick="restartGame()">üîÑ Restart</button>
            </div>
        </div>
        
        <div class="main-content">
            <div class="collectibles-pane" id="collectibles-pane">
                <h3>üé® Collection</h3>
                <div class="collectibles-grid" id="collectibles-pane-grid"></div>
            </div>
            
            <div class="game-area">
                <div class="game-board">
                    <div class="background" id="background">
                        <div class="emoji" id="emoji">ü¶Ñ</div>
                    </div>
                    <div class="grid-overlay" id="grid"></div>
                </div>
                
                <div class="question-box" id="question-box">
                    <div class="paused-overlay" id="paused-overlay">
                        <div class="paused-text">‚è∏Ô∏è Paused</div>
                    </div>
                    <div class="timer" id="timer">0s</div>
                    <div class="question" id="question">What is 2 + 2?</div>
                    <input type="number" class="answer-input" id="answer-input" autofocus>
                    <br>
                    <button class="check-button" onclick="checkAnswer()">Check Answer!</button>
                    <div class="feedback" id="feedback"></div>
                </div>
            </div>
        </div>
        
        <div class="completion" id="completion" style="display: none;">
            <h2>üéâ Amazing Work! üéâ</h2>
            <p id="completion-text">You revealed the Unicorn!</p>
            <div class="new-collectible" id="new-collectible">ü¶Ñ</div>
            <p style="color: #8b5cf6; font-size: 1.3rem; font-weight: bold;">Added to your collection!</p>
            <button class="next-level-button" id="next-level-button" onclick="goToNextLevel()">Next Level ‚Üí</button>
            <div id="reports-container"></div>
        </div>
    </div>

    <script>
        const GRID_SIZE = 8;
        const GRID_OFFSET = 2;
        const CELLS_PER_ANSWER = 6;
        const MIN_LEVEL_2_QUESTIONS = 10;
        const MIN_LEVEL_4_QUESTIONS = 10;

        const PRACTICE_TYPES = {
            A: {
                name: 'Practice',
                cellsPerAnswer: 6,
                requiresRetry: true,
                questionSource: 'random'
            },
            B: {
                name: 'Challenge Review',
                cellsPerAnswer: (totalQuestions) => Math.ceil(64 / totalQuestions),
                requiresRetry: false,
                questionSource: 'practice-set',
                minQuestions: 10
            },
            C: {
                name: 'Boss Challenge',
                cellsPerAnswer: 4,
                requiresRetry: true,
                questionSource: 'mixed',
                timeLimit: null
            }
        };

        const QUESTION_TYPES = {
            'single-add': {
                operation: '+',
                operationFn: (a, b) => a + b,
                rowRange: [2, 10],
                colRange: [2, 10],
                label: 'Single-Digit Addition',
                operationSymbol: '+'
            },
            'double-add': {
                operation: '+',
                operationFn: (a, b) => a + b,
                rowRange: [11, 90],
                colRange: [2, 9],
                label: 'Double-Digit Addition',
                operationSymbol: '+'
            },
            'single-sub': {
                operation: '-',
                operationFn: (a, b) => a - b,
                rowRange: [2, 10],
                colRange: [2, 10],
                label: 'Single-Digit Subtraction',
                operationSymbol: '-'
            },
            'double-sub': {
                operation: '-',
                operationFn: (a, b) => a - b,
                rowRange: [11, 90],
                colRange: [2, 9],
                label: 'Double-Digit Subtraction',
                operationSymbol: '-'
            },
            'mixed-add': {
                operation: '+',
                operationFn: (a, b) => a + b,
                rowRange: [2, 90],
                colRange: [2, 10],
                label: 'Mixed Addition',
                operationSymbol: '+'
            },
            'mixed-sub': {
                operation: '-',
                operationFn: (a, b) => a - b,
                rowRange: [2, 90],
                colRange: [2, 10],
                label: 'Mixed Subtraction',
                operationSymbol: '-'
            }
        };

        const LEVEL_CONFIG = {
            1: {
                practiceType: 'A',
                questionType: 'single-add',
                theme: 'purple',
                sourceLevel: null,
                title: 'LEVEL 1',
                description: 'Practice Addition!'
            },
            2: {
                practiceType: 'B',
                questionType: 'single-add',
                theme: 'orange',
                sourceLevel: 1,
                title: 'LEVEL 2',
                description: (numQuestions) => `Practice ${numQuestions} Challenging Questions!`
            },
            3: {
                practiceType: 'A',
                questionType: 'double-add',
                theme: 'green',
                sourceLevel: null,
                title: 'LEVEL 3',
                description: 'Double Digit Addition!'
            },
            4: {
                practiceType: 'B',
                questionType: 'double-add',
                theme: 'indigo',
                sourceLevel: 3,
                title: 'LEVEL 4',
                description: (numQuestions) => `Practice ${numQuestions} Challenging Questions!`
            }
        };

        const urlParams = new URLSearchParams(window.location.search);
        const testMode = urlParams.get('test') === 'true';
        if (testMode) {
            document.getElementById('test-panel').classList.add('visible');
        }
        
        const backgrounds = [
            { gradient: 'linear-gradient(135deg, #ffc0cb 0%, #e9d5ff 50%, #bfdbfe 100%)', emoji: 'ü¶Ñ', name: 'Unicorn', baseRarity: 'legendary' },
            { gradient: 'linear-gradient(135deg, #fef3c7 0%, #fed7aa 50%, #ffc0cb 100%)', emoji: 'üê±', name: 'Kitty', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 50%, #bfdbfe 100%)', emoji: 'üê¨', name: 'Dolphin', baseRarity: 'rare' },
            { gradient: 'linear-gradient(135deg, #fef08a 0%, #fde047 50%, #fcd34d 100%)', emoji: 'üêª', name: 'Bear', baseRarity: 'uncommon' },
            { gradient: 'linear-gradient(135deg, #fecaca 0%, #fca5a5 50%, #f87171 100%)', emoji: 'ü¶ä', name: 'Fox', baseRarity: 'uncommon' },
            { gradient: 'linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 50%, #a78bfa 100%)', emoji: 'ü¶ã', name: 'Butterfly', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #fde68a 0%, #fcd34d 50%, #fbbf24 100%)', emoji: 'üêù', name: 'Bee', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #fed7aa 0%, #fdba74 50%, #fb923c 100%)', emoji: 'ü¶Å', name: 'Lion', baseRarity: 'rare' },
            { gradient: 'linear-gradient(135deg, #bae6fd 0%, #7dd3fc 50%, #38bdf8 100%)', emoji: 'üêß', name: 'Penguin', baseRarity: 'uncommon' },
            { gradient: 'linear-gradient(135deg, #d9f99d 0%, #bef264 50%, #a3e635 100%)', emoji: 'üê∏', name: 'Frog', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #fecdd3 0%, #fda4af 50%, #fb7185 100%)', emoji: 'üê∑', name: 'Pig', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 50%, #a5b4fc 100%)', emoji: 'üêò', name: 'Elephant', baseRarity: 'rare' },
            { gradient: 'linear-gradient(135deg, #ccfbf1 0%, #99f6e4 50%, #5eead4 100%)', emoji: 'ü¶ï', name: 'Dinosaur', baseRarity: 'legendary' },
            { gradient: 'linear-gradient(135deg, #fce7f3 0%, #fbcfe8 50%, #f9a8d4 100%)', emoji: 'ü¶©', name: 'Flamingo', baseRarity: 'uncommon' },
            { gradient: 'linear-gradient(135deg, #fef9c3 0%, #fef08a 50%, #fde047 100%)', emoji: 'üê•', name: 'Chick', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #f5f3ff 0%, #ede9fe 50%, #ddd6fe 100%)', emoji: 'ü¶â', name: 'Owl', baseRarity: 'uncommon' },
            { gradient: 'linear-gradient(135deg, #ffedd5 0%, #fed7aa 50%, #fdba74 100%)', emoji: 'ü¶ò', name: 'Kangaroo', baseRarity: 'rare' },
            { gradient: 'linear-gradient(135deg, #dbeafe 0%, #bfdbfe 50%, #93c5fd 100%)', emoji: 'üêã', name: 'Whale', baseRarity: 'epic' },
            { gradient: 'linear-gradient(135deg, #fef3c7 0%, #fde047 50%, #facc15 100%)', emoji: 'üê§', name: 'Baby Chick', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #fed7aa 0%, #fb923c 50%, #f97316 100%)', emoji: 'ü¶Ä', name: 'Crab', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #e0f2fe 0%, #7dd3fc 50%, #0ea5e9 100%)', emoji: 'üêü', name: 'Fish', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #d1fae5 0%, #6ee7b7 50%, #10b981 100%)', emoji: 'üê¢', name: 'Turtle', baseRarity: 'uncommon' },
            { gradient: 'linear-gradient(135deg, #fef08a 0%, #facc15 50%, #eab308 100%)', emoji: 'üê≠', name: 'Mouse', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #fecaca 0%, #f87171 50%, #ef4444 100%)', emoji: 'üêπ', name: 'Hamster', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #ddd6fe 0%, #a78bfa 50%, #8b5cf6 100%)', emoji: 'üê∞', name: 'Rabbit', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #fed7aa 0%, #fdba74 50%, #f97316 100%)', emoji: 'ü¶î', name: 'Hedgehog', baseRarity: 'uncommon' },
            { gradient: 'linear-gradient(135deg, #d9f99d 0%, #a3e635 50%, #84cc16 100%)', emoji: 'ü¶é', name: 'Lizard', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #fbcfe8 0%, #f472b6 50%, #ec4899 100%)', emoji: 'üêô', name: 'Octopus', baseRarity: 'uncommon' },
            { gradient: 'linear-gradient(135deg, #bae6fd 0%, #38bdf8 50%, #0284c7 100%)', emoji: 'ü¶à', name: 'Shark', baseRarity: 'rare' },
            { gradient: 'linear-gradient(135deg, #fde68a 0%, #fbbf24 50%, #f59e0b 100%)', emoji: 'üê®', name: 'Koala', baseRarity: 'rare' },
            { gradient: 'linear-gradient(135deg, #c7d2fe 0%, #818cf8 50%, #6366f1 100%)', emoji: 'ü¶á', name: 'Bat', baseRarity: 'uncommon' },
            { gradient: 'linear-gradient(135deg, #fecdd3 0%, #fb7185 50%, #f43f5e 100%)', emoji: 'ü¶û', name: 'Lobster', baseRarity: 'uncommon' },
            { gradient: 'linear-gradient(135deg, #ccfbf1 0%, #5eead4 50%, #14b8a6 100%)', emoji: 'üêä', name: 'Crocodile', baseRarity: 'rare' },
            { gradient: 'linear-gradient(135deg, #fef9c3 0%, #fde047 50%, #facc15 100%)', emoji: 'ü¶í', name: 'Giraffe', baseRarity: 'rare' },
            { gradient: 'linear-gradient(135deg, #e0e7ff 0%, #a5b4fc 50%, #818cf8 100%)', emoji: 'ü¶è', name: 'Rhino', baseRarity: 'epic' },
            { gradient: 'linear-gradient(135deg, #d1fae5 0%, #6ee7b7 50%, #34d399 100%)', emoji: 'ü¶õ', name: 'Hippo', baseRarity: 'rare' },
            { gradient: 'linear-gradient(135deg, #fed7aa 0%, #fb923c 50%, #ea580c 100%)', emoji: 'üêØ', name: 'Tiger', baseRarity: 'epic' },
            { gradient: 'linear-gradient(135deg, #fef3c7 0%, #fcd34d 50%, #f59e0b 100%)', emoji: 'üêµ', name: 'Monkey', baseRarity: 'uncommon' },
            { gradient: 'linear-gradient(135deg, #fecaca 0%, #fca5a5 50%, #f87171 100%)', emoji: 'ü¶ô', name: 'Llama', baseRarity: 'uncommon' },
            { gradient: 'linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 50%, #a78bfa 100%)', emoji: 'ü¶ö', name: 'Peacock', baseRarity: 'rare' },
            { gradient: 'linear-gradient(135deg, #bae6fd 0%, #7dd3fc 50%, #38bdf8 100%)', emoji: 'üê¶', name: 'Bird', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #fde68a 0%, #fbbf24 50%, #f59e0b 100%)', emoji: 'üê¥', name: 'Horse', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #d9f99d 0%, #bef264 50%, #a3e635 100%)', emoji: 'ü¶ó', name: 'Cricket', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #fbcfe8 0%, #f9a8d4 50%, #f472b6 100%)', emoji: 'ü¶ü', name: 'Mosquito', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #ccfbf1 0%, #99f6e4 50%, #5eead4 100%)', emoji: 'üêå', name: 'Snail', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #fef9c3 0%, #fef08a 50%, #fde047 100%)', emoji: 'ü¶Ü', name: 'Duck', baseRarity: 'common' },
            { gradient: 'linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 50%, #a5b4fc 100%)', emoji: 'ü¶¢', name: 'Swan', baseRarity: 'uncommon' },
            { gradient: 'linear-gradient(135deg, #fed7aa 0%, #fdba74 50%, #fb923c 100%)', emoji: 'ü¶ú', name: 'Parrot', baseRarity: 'uncommon' },
            { gradient: 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 50%, #6ee7b7 100%)', emoji: 'ü¶ñ', name: 'T-Rex', baseRarity: 'legendary' },
            { gradient: 'linear-gradient(135deg, #fde68a 0%, #fcd34d 50%, #fbbf24 100%)', emoji: 'üêøÔ∏è', name: 'Squirrel', baseRarity: 'common' }
        ];
        
        const rarityColors = {
            common: '#f3f4f6',
            uncommon: '#d1fae5',
            rare: '#dbeafe',
            epic: '#e9d5ff',
            legendary: '#fef3c7'
        };
        
        const rarityLabels = {
            common: 'Common',
            uncommon: 'Uncommon',
            rare: 'Rare',
            epic: 'Epic',
            legendary: 'Legendary'
        };
        
        function getHighestLevel() {
            try {
                const saved = localStorage.getItem('mathGameHighestLevel');
                return saved ? parseInt(saved) : 1;
            } catch (e) {
                return 1;
            }
        }
        
        function saveHighestLevel(level) {
            try {
                const current = getHighestLevel();
                if (level > current) {
                    localStorage.setItem('mathGameHighestLevel', level.toString());
                }
            } catch (e) {
                console.error('Error saving highest level:', e);
            }
        }
        
        function determineRarity(highestLevel) {
            let probabilities = {
                common: 60,
                uncommon: 25,
                rare: 10,
                epic: 4,
                legendary: 1
            };
            
            if (highestLevel > 1) {
                const levelBonus = (highestLevel - 1) * 2;
                const reduction = levelBonus / 2;
                
                probabilities.common = Math.max(30, probabilities.common - reduction);
                probabilities.uncommon = Math.max(15, probabilities.uncommon - reduction);
                probabilities.rare += levelBonus * 0.5;
                probabilities.epic += levelBonus * 0.3;
                probabilities.legendary += levelBonus * 0.2;
            }
            
            const random = Math.random() * 100;
            let cumulative = 0;
            
            for (const [rarity, probability] of Object.entries(probabilities)) {
                cumulative += probability;
                if (random < cumulative) {
                    return rarity;
                }
            }
            
            return 'common';
        }
        
        let currentLevel = 1;
        let currentBg = null;
        let cells = {};
        let currentQuestion = null;
        let cellsDiscovered = 0;
        let totalMistakes = 0;
        let mistakeLog = {};
        let slowLog = {};
        let fastLog = {};
        let allTimesLog = {};
        let level1MistakeLog = {};
        let level1SlowLog = {};
        let level3MistakeLog = {};
        let level3SlowLog = {};
        let practiceQuestions = [];
        let questionsSinceLastMistake = 0;
        let pendingRetry = null;
        let questionStartTime = null;
        let timerInterval = null;
        let audioContext = null;
        let isPaused = false;
        let pausedTime = 0;
        
        function saveCollection(collection) {
            try {
                localStorage.setItem('mathGameCollection', JSON.stringify(collection));
            } catch (e) {
                console.error('Error saving collection:', e);
            }
        }
        
        function loadCollection() {
            try {
                const saved = localStorage.getItem('mathGameCollection');
                if (saved) {
                    return JSON.parse(saved);
                }
            } catch (e) {
                console.error('Error loading collection:', e);
            }
            return [];
        }
        
        function addToCollection(emoji, name) {
            const collection = loadCollection();
            const existing = collection.find(item => item.emoji === emoji);
            
            if (existing) {
                existing.count = (existing.count || 1) + 1;
                existing.lastFound = new Date().toISOString();
            } else {
                const animal = backgrounds.find(bg => bg.emoji === emoji);
                const rarity = animal ? animal.baseRarity : 'common';
                
                const newItem = { 
                    emoji, 
                    name, 
                    rarity, 
                    count: 1,
                    firstFound: new Date().toISOString(),
                    lastFound: new Date().toISOString()
                };
                collection.push(newItem);
            }
            
            saveCollection(collection);
            updateCollectionCount();
        }
        
        function removeFromCollection(emoji) {
            if (!testMode) return;
            const collection = loadCollection();
            const item = collection.find(c => c.emoji === emoji);
            
            if (item) {
                if ((item.count || 1) > 1) {
                    item.count--;
                } else {
                    const index = collection.indexOf(item);
                    collection.splice(index, 1);
                }
                saveCollection(collection);
                updateCollectionCount();
                viewCollection();
            }
        }
        
        function updateCollectionCount() {
            const collection = loadCollection();
            const totalCount = collection.reduce((sum, item) => sum + (item.count || 1), 0);
            document.getElementById('collection-count').textContent = `üìö Collection: ${totalCount}`;
            updateCollectiblesPane();
        }
        
        function updateCollectiblesPane() {
            const collection = loadCollection();
            const paneGrid = document.getElementById('collectibles-pane-grid');
            paneGrid.innerHTML = '';
            
            if (collection.length === 0) {
                paneGrid.innerHTML = '<div class="collectible-empty">Complete games to collect animals! üéØ</div>';
            } else {
                collection.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'collectible-item';
                    div.innerHTML = item.emoji;
                    div.title = `${item.name} - ${rarityLabels[item.rarity || 'common']} (x${item.count || 1})`;
                    div.style.background = rarityColors[item.rarity || 'common'];
                    div.onclick = () => viewCollection();
                    
                    if ((item.count || 1) > 1) {
                        const badge = document.createElement('div');
                        badge.className = 'collectible-count-badge';
                        badge.textContent = item.count || 1;
                        div.appendChild(badge);
                    }
                    
                    paneGrid.appendChild(div);
                });
            }
        }
        
        function viewCollection() {
            const collection = loadCollection();
            const grid = document.getElementById('collection-grid');
            grid.innerHTML = '';
            
            if (collection.length === 0) {
                grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #9ca3af; font-size: 1.2rem;">No collectibles yet! Complete games to collect cute animals! üéØ</p>';
            } else {
                collection.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'collection-item';
                    div.style.background = rarityColors[item.rarity || 'common'];
                    
                    const emoji = document.createElement('div');
                    emoji.textContent = item.emoji;
                    div.appendChild(emoji);
                    
                    const tooltip = document.createElement('div');
                    tooltip.className = 'collection-item-tooltip';
                    tooltip.textContent = `${rarityLabels[item.rarity || 'common']} - Found ${item.count || 1}x`;
                    div.appendChild(tooltip);
                    
                    if ((item.count || 1) > 1) {
                        const badge = document.createElement('div');
                        badge.className = 'collectible-count-badge';
                        badge.textContent = item.count || 1;
                        div.appendChild(badge);
                    }
                    
                    if (testMode) {
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'delete-collectible';
                        deleteBtn.textContent = '√ó';
                        deleteBtn.onclick = (e) => {
                            e.stopPropagation();
                            if (confirm(`Remove ${item.name} from collection?`)) {
                                removeFromCollection(item.emoji);
                            }
                        };
                        div.appendChild(deleteBtn);
                    }
                    
                    grid.appendChild(div);
                });
            }
            
            document.getElementById('collection-modal').classList.add('visible');
        }
        
        function closeCollection() {
            document.getElementById('collection-modal').classList.remove('visible');
        }
        
        function selectRandomBackground() {
            const highestLevel = getHighestLevel();
            const targetRarity = determineRarity(highestLevel);
            
            const matchingRarity = backgrounds.filter(bg => bg.baseRarity === targetRarity);
            
            if (matchingRarity.length > 0) {
                return matchingRarity[Math.floor(Math.random() * matchingRarity.length)];
            } else {
                return backgrounds[Math.floor(Math.random() * backgrounds.length)];
            }
        }
        
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }
        
        function playSound(frequency, duration, type = 'sine', delay = 0) {
            initAudio();
            if (!audioContext) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = type;
            
            const startTime = audioContext.currentTime + delay;
            gainNode.gain.setValueAtTime(0.3, startTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + duration);
            
            oscillator.start(startTime);
            oscillator.stop(startTime + duration);
        }
        
        function playSuccessSound() {
            playSound(523.25, 0.1, 'sine', 0);
            playSound(659.25, 0.1, 'sine', 0.1);
            playSound(783.99, 0.2, 'sine', 0.2);
        }
        
        function playCellRevealSound() {
            playSound(523.25, 0.15, 'sine', 0);
            playSound(659.25, 0.15, 'sine', 0.08);
            playSound(783.99, 0.15, 'sine', 0.16);
            playSound(1046.50, 0.3, 'sine', 0.24);
        }
        
        function playFailSound() {
            playSound(392, 0.15, 'sine', 0);
            playSound(349.23, 0.3, 'sine', 0.15);
        }
        
        function playCompletionSound() {
            playSound(523.25, 0.2, 'sine', 0);
            playSound(659.25, 0.2, 'sine', 0.15);
            playSound(783.99, 0.2, 'sine', 0.3);
            playSound(1046.50, 0.25, 'sine', 0.45);
            playSound(783.99, 0.2, 'sine', 0.7);
            playSound(1046.50, 0.25, 'sine', 0.85);
            playSound(1318.51, 0.3, 'sine', 1.0);
            playSound(1046.50, 0.2, 'sine', 1.3);
            playSound(1318.51, 0.4, 'sine', 1.45);
            playSound(1567.98, 0.6, 'sine', 1.7);
        }
        
        function updateTimer() {
            if (!questionStartTime || isPaused) return;
            const elapsed = Math.floor((Date.now() - questionStartTime - pausedTime) / 1000);
            document.getElementById('timer').textContent = `${elapsed}s`;
        }
        
        function startTimer() {
            questionStartTime = Date.now();
            pausedTime = 0;
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(updateTimer, 1000);
            updateTimer();
        }
        
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            return questionStartTime ? Math.floor((Date.now() - questionStartTime - pausedTime) / 1000) : 0;
        }
        
        function togglePause() {
            isPaused = !isPaused;
            const overlay = document.getElementById('paused-overlay');
            const pauseButton = document.getElementById('pause-button');
            
            if (isPaused) {
                overlay.classList.add('visible');
                pauseButton.textContent = '‚ñ∂Ô∏è Resume';
                const pauseStart = Date.now();
                pauseButton.dataset.pauseStart = pauseStart;
            } else {
                overlay.classList.remove('visible');
                pauseButton.textContent = '‚è∏Ô∏è Pause';
                const pauseDuration = Date.now() - parseInt(pauseButton.dataset.pauseStart);
                pausedTime += pauseDuration;
                updateTimer();
            }
        }
        
        function createCrackSVG() {
            let color = '#8b5cf6';
            if (currentLevel === 2) color = '#f59e0b';
            if (currentLevel === 3) color = '#10b981';
            if (currentLevel === 4) color = '#6366f1';
            
            return `<svg width="62.5" height="62.5" xmlns="http://www.w3.org/2000/svg">
                <path d="M 10 0 L 15 20 L 25 15 L 30 35 L 40 30" 
                      stroke="${color}" stroke-width="2" fill="none" opacity="0.8"/>
                <path d="M 30 0 L 35 25 L 45 20 L 50 40" 
                      stroke="${color}" stroke-width="2" fill="none" opacity="0.8"/>
                <path d="M 0 20 L 20 25 L 15 40 L 30 45" 
                      stroke="${color}" stroke-width="2" fill="none" opacity="0.8"/>
                <path d="M 20 50 L 30 55 L 40 50 L 50 62.5" 
                      stroke="${color}" stroke-width="2" fill="none" opacity="0.8"/>
            </svg>`;
        }
        
        function createGrid() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            
            for (let rowIndex = 0; rowIndex < GRID_SIZE; rowIndex++) {
                const row = rowIndex + GRID_OFFSET;
                const rowDiv = document.createElement('div');
                rowDiv.className = 'grid-row';
                
                for (let colIndex = 0; colIndex < GRID_SIZE; colIndex++) {
                    const col = colIndex + GRID_OFFSET;
                    const cellKey = `${row}-${col}`;
                    
                    const cellDiv = document.createElement('div');
                    cellDiv.className = 'grid-cell';
                    cellDiv.id = cellKey;
                    
                    const coverDiv = document.createElement('div');
                    coverDiv.className = 'cell-cover';
                    coverDiv.id = `${cellKey}-cover`;
                    
                    const cracksDiv = document.createElement('div');
                    cracksDiv.className = 'cell-cracks';
                    cracksDiv.id = `${cellKey}-cracks`;
                    cracksDiv.innerHTML = createCrackSVG();
                    
                    cellDiv.appendChild(coverDiv);
                    cellDiv.appendChild(cracksDiv);
                    rowDiv.appendChild(cellDiv);
                }
                
                grid.appendChild(rowDiv);
            }
        }
        
        function updateCell(cellKey) {
            const cell = cells[cellKey];
            const coverDiv = document.getElementById(`${cellKey}-cover`);
            const cracksDiv = document.getElementById(`${cellKey}-cracks`);
            
            if (coverDiv && cracksDiv) {
                if (cell.correctAnswers === 0) {
                    coverDiv.style.opacity = '1';
                    cracksDiv.style.opacity = '0';
                } else if (cell.correctAnswers === 1) {
                    coverDiv.style.opacity = '0.7';
                    cracksDiv.style.opacity = '1';
                } else {
                    coverDiv.style.opacity = '0';
                    cracksDiv.style.opacity = '0';
                }
            }
        }
        
        function initializeLevel() {
            cells = {};
            
            for (let row = GRID_OFFSET; row < GRID_SIZE + GRID_OFFSET; row++) {
                for (let col = GRID_OFFSET; col < GRID_SIZE + GRID_OFFSET; col++) {
                    cells[`${row}-${col}`] = { correctAnswers: 0, completed: false };
                }
            }
            cellsDiscovered = 0;
            
            totalMistakes = 0;
            mistakeLog = {};
            slowLog = {};
            fastLog = {};

            const levelConfig = LEVEL_CONFIG[currentLevel];
            const practiceType = PRACTICE_TYPES[levelConfig.practiceType];

            if (practiceType.questionSource === 'random') {
                allTimesLog = {};
            }
            questionsSinceLastMistake = 0;
            pendingRetry = null;

            document.getElementById('progress-text').textContent = `${cellsDiscovered}/64 Cells Discovered!`;
            document.getElementById('mistakes-text').textContent = 'Mistakes: 0';
        }

        function showLevelIntro() {
            const intro = document.getElementById('level-intro');
            const title = document.getElementById('level-intro-title');
            const desc = document.getElementById('level-intro-desc');

            const levelConfig = LEVEL_CONFIG[currentLevel];

            document.body.className = '';
            if (levelConfig.theme === 'orange') document.body.classList.add('level-2');
            if (levelConfig.theme === 'green') document.body.classList.add('level-3');
            if (levelConfig.theme === 'indigo') document.body.classList.add('level-4');

            title.textContent = levelConfig.title;

            const description = typeof levelConfig.description === 'function'
                ? levelConfig.description(practiceQuestions.length)
                : levelConfig.description;
            desc.textContent = description;

            document.getElementById('level-badge').textContent = `Level ${currentLevel}`;
            intro.classList.add('visible');
        }
        
        function startLevel() {
            document.getElementById('level-intro').classList.remove('visible');
            currentBg = selectRandomBackground();
            document.getElementById('background').style.background = currentBg.gradient;
            document.getElementById('emoji').textContent = currentBg.emoji;

            initializeLevel();
            createGrid();
            generateQuestion();
        }

        function generateRandomQuestionFromType(questionType) {
            const qType = QUESTION_TYPES[questionType];
            const [rowMin, rowMax] = qType.rowRange;
            const [colMin, colMax] = qType.colRange;

            const row = Math.floor(Math.random() * (rowMax - rowMin + 1)) + rowMin;
            const col = Math.floor(Math.random() * (colMax - colMin + 1)) + colMin;
            const answer = qType.operationFn(row, col);

            return { row, col, answer };
        }

        function generateQuestion() {
            const levelConfig = LEVEL_CONFIG[currentLevel];
            const practiceType = PRACTICE_TYPES[levelConfig.practiceType];
            const questionType = QUESTION_TYPES[levelConfig.questionType];

            const allRevealed = Object.values(cells).every(cell => cell.correctAnswers >= 2);
            if (allRevealed) {
                showCompletion();
                return;
            }

            if (practiceType.questionSource === 'random') {
                if (pendingRetry && questionsSinceLastMistake >= 2) {
                    currentQuestion = pendingRetry;
                    pendingRetry = null;
                    questionsSinceLastMistake = 0;
                } else {
                    currentQuestion = generateRandomQuestionFromType(levelConfig.questionType);
                }
            } else if (practiceType.questionSource === 'practice-set') {
                if (practiceQuestions.length === 0) {
                    showCompletion();
                    return;
                }

                const randomQ = practiceQuestions[Math.floor(Math.random() * practiceQuestions.length)];
                const answer = questionType.operationFn(randomQ.row, randomQ.col);
                currentQuestion = { row: randomQ.row, col: randomQ.col, answer: answer };
            }

            document.getElementById('question').textContent = `What is ${currentQuestion.row} ${questionType.operationSymbol} ${currentQuestion.col}?`;
            document.getElementById('answer-input').value = '';
            document.getElementById('feedback').textContent = '';
            document.getElementById('answer-input').focus();
            startTimer();
        }
        
        function checkAnswer() {
            if (isPaused) return;

            initAudio();
            const userAnswer = parseInt(document.getElementById('answer-input').value);
            if (!currentQuestion || isNaN(userAnswer)) return;

            const levelConfig = LEVEL_CONFIG[currentLevel];
            const practiceType = PRACTICE_TYPES[levelConfig.practiceType];
            const questionType = QUESTION_TYPES[levelConfig.questionType];

            const timeSpent = stopTimer();
            const isCorrect = userAnswer === currentQuestion.answer;
            const feedbackDiv = document.getElementById('feedback');

            if (isCorrect) {
                feedbackDiv.textContent = '‚ú® Correct! Great job!';
                feedbackDiv.className = 'feedback correct';

                const canProgress = Object.keys(cells).filter(key => cells[key].correctAnswers < 2);

                if (canProgress.length === 0) {
                    playSuccessSound();
                    setTimeout(() => {
                        showCompletion();
                    }, 1000);
                    return;
                }

                const cellsPerAnswer = typeof practiceType.cellsPerAnswer === 'function'
                    ? practiceType.cellsPerAnswer(practiceQuestions.length)
                    : practiceType.cellsPerAnswer;

                const shuffled = canProgress.sort(() => Math.random() - 0.5);
                const numToProgress = Math.min(cellsPerAnswer, canProgress.length);

                let newlyCompleted = 0;
                for (let i = 0; i < numToProgress; i++) {
                    const cellKey = shuffled[i];
                    cells[cellKey].correctAnswers++;

                    if (cells[cellKey].correctAnswers >= 2) {
                        cells[cellKey].completed = true;
                        cellsDiscovered++;
                        newlyCompleted++;
                    }

                    updateCell(cellKey);
                }

                if (newlyCompleted > 0) {
                    playCellRevealSound();
                } else {
                    playSuccessSound();
                }

                document.getElementById('progress-text').textContent = `${cellsDiscovered}/64 Cells Discovered!`;

                const questionKey = `${currentQuestion.row}${questionType.operationSymbol}${currentQuestion.col}`;

                if (practiceType.questionSource === 'random') {
                    if (!allTimesLog[questionKey]) allTimesLog[questionKey] = [];
                    allTimesLog[questionKey].push(timeSpent);
                }

                if (timeSpent < 5) {
                    if (!fastLog[questionKey]) fastLog[questionKey] = [];
                    fastLog[questionKey].push(timeSpent);
                }

                if (timeSpent >= 20) {
                    if (!slowLog[questionKey]) slowLog[questionKey] = [];
                    slowLog[questionKey].push(timeSpent);
                }

                if (practiceType.requiresRetry) {
                    questionsSinceLastMistake++;
                }

                setTimeout(generateQuestion, 1000);
            } else {
                feedbackDiv.textContent = 'ü§î Not quite! Try again!';
                feedbackDiv.className = 'feedback incorrect';

                playFailSound();

                document.getElementById('answer-input').value = '';

                totalMistakes++;
                document.getElementById('mistakes-text').textContent = `Mistakes: ${totalMistakes}`;

                const questionKey = `${currentQuestion.row}${questionType.operationSymbol}${currentQuestion.col}`;
                if (!mistakeLog[questionKey]) mistakeLog[questionKey] = 0;
                mistakeLog[questionKey]++;

                if (practiceType.requiresRetry) {
                    if (!pendingRetry || (pendingRetry.row !== currentQuestion.row || pendingRetry.col !== currentQuestion.col)) {
                        pendingRetry = { row: currentQuestion.row, col: currentQuestion.col, answer: currentQuestion.answer };
                        questionsSinceLastMistake = 0;
                    }
                }

                const cellsPerAnswer = typeof practiceType.cellsPerAnswer === 'function'
                    ? practiceType.cellsPerAnswer(practiceQuestions.length)
                    : practiceType.cellsPerAnswer;

                const canRegress = Object.keys(cells).filter(key => cells[key].correctAnswers > 0);

                if (canRegress.length > 0) {
                    const shuffled = canRegress.sort(() => Math.random() - 0.5);
                    const numToRegress = Math.min(cellsPerAnswer, canRegress.length);

                    for (let i = 0; i < numToRegress; i++) {
                        const cellKey = shuffled[i];

                        if (cells[cellKey].correctAnswers === 2) {
                            cells[cellKey].completed = false;
                            cellsDiscovered--;
                        }

                        cells[cellKey].correctAnswers = Math.max(0, cells[cellKey].correctAnswers - 1);
                        updateCell(cellKey);
                    }
                }

                document.getElementById('progress-text').textContent = `${cellsDiscovered}/64 Cells Discovered!`;

                startTimer();
            }
        }
        
        function revealAll() {
            if (!confirm('This will complete all remaining cells and end the game. Continue?')) {
                return;
            }

            for (let key in cells) {
                if (!cells[key].completed) {
                    cells[key].correctAnswers = 2;
                    cells[key].completed = true;
                    updateCell(key);
                }
            }

            cellsDiscovered = 64;
            document.getElementById('progress-text').textContent = '64/64 Cells Discovered!';
            showCompletion();
        }

        function generatePracticeQuestions(sourceLevel) {
            const sourceLevelConfig = LEVEL_CONFIG[sourceLevel];
            const targetLevel = sourceLevel + 1;
            const targetLevelConfig = LEVEL_CONFIG[targetLevel];
            const practiceType = PRACTICE_TYPES[targetLevelConfig.practiceType];
            const questionType = QUESTION_TYPES[sourceLevelConfig.questionType];

            const mistakeLogVar = sourceLevel === 1 ? level1MistakeLog : level3MistakeLog;
            const slowLogVar = sourceLevel === 1 ? level1SlowLog : level3SlowLog;

            const questions = [];
            const questionSet = new Set();

            const operationSymbol = questionType.operationSymbol;

            for (const questionKey in mistakeLogVar) {
                const [row, col] = questionKey.split(operationSymbol).map(Number);
                const key = `${row}-${col}`;
                if (!questionSet.has(key)) {
                    questions.push({ row, col });
                    questionSet.add(key);
                }
            }

            for (const questionKey in slowLogVar) {
                const [row, col] = questionKey.split(operationSymbol).map(Number);
                const key = `${row}-${col}`;
                if (!questionSet.has(key)) {
                    questions.push({ row, col });
                    questionSet.add(key);
                }
            }

            if (questions.length < practiceType.minQuestions) {
                const avgTimes = [];
                for (const questionKey in allTimesLog) {
                    const times = allTimesLog[questionKey];
                    const avgTime = times.reduce((sum, t) => sum + t, 0) / times.length;
                    const [row, col] = questionKey.split(operationSymbol).map(Number);
                    const key = `${row}-${col}`;

                    if (!questionSet.has(key)) {
                        avgTimes.push({ row, col, avgTime, key });
                    }
                }

                avgTimes.sort((a, b) => b.avgTime - a.avgTime);

                const needed = practiceType.minQuestions - questions.length;
                for (let i = 0; i < Math.min(needed, avgTimes.length); i++) {
                    questions.push({ row: avgTimes[i].row, col: avgTimes[i].col });
                    questionSet.add(avgTimes[i].key);
                }
            }

            return questions;
        }

        function showCompletion() {
            stopTimer();
            playCompletionSound();

            saveHighestLevel(currentLevel);

            addToCollection(currentBg.emoji, currentBg.name);

            const levelConfig = LEVEL_CONFIG[currentLevel];

            if (levelConfig.sourceLevel === null) {
                if (currentLevel === 1) {
                    level1MistakeLog = { ...mistakeLog };
                    level1SlowLog = { ...slowLog };
                } else if (currentLevel === 3) {
                    level3MistakeLog = { ...mistakeLog };
                    level3SlowLog = { ...slowLog };
                }

                const nextLevel = currentLevel + 1;
                if (LEVEL_CONFIG[nextLevel]) {
                    practiceQuestions = generatePracticeQuestions(currentLevel);
                }
            }
            
            document.getElementById('question-box').style.display = 'none';
            document.getElementById('completion').style.display = 'block';
            document.getElementById('completion-text').textContent = `You revealed the ${currentBg.name}!`;
            document.getElementById('new-collectible').textContent = currentBg.emoji;
            
            const nextLevelBtn = document.getElementById('next-level-button');
            const nextLevel = currentLevel + 1;
            if (LEVEL_CONFIG[nextLevel] && (levelConfig.sourceLevel === null ? practiceQuestions.length > 0 : true)) {
                nextLevelBtn.style.display = 'inline-block';
            } else {
                nextLevelBtn.style.display = 'none';
            }
            
            const reportsContainer = document.getElementById('reports-container');
            let reportsHTML = '';
            
            if (Object.keys(fastLog).length > 0) {
                reportsHTML += '<div class="achievement-report"><h3>üåü Speed Achievements (Under 5 seconds):</h3><ul>';
                const sortedFast = Object.entries(fastLog).sort((a, b) => {
                    const avgA = a[1].reduce((sum, t) => sum + t, 0) / a[1].length;
                    const avgB = b[1].reduce((sum, t) => sum + t, 0) / b[1].length;
                    return avgA - avgB;
                });
                for (const [question, times] of sortedFast) {
                    const avgTime = (times.reduce((sum, t) => sum + t, 0) / times.length).toFixed(1);
                    reportsHTML += `<li>${question} (${avgTime}s avg)</li>`;
                }
                reportsHTML += '</ul></div>';
            }
            
            if (totalMistakes > 0) {
                reportsHTML += '<div class="mistake-report"><h3>Questions with Mistakes:</h3><ul>';
                const sortedMistakes = Object.entries(mistakeLog).sort((a, b) => b[1] - a[1]);
                for (const [question, count] of sortedMistakes) {
                    reportsHTML += `<li>${question} (${count} mistake${count > 1 ? 's' : ''})</li>`;
                }
                reportsHTML += '</ul></div>';
            }
            
            if (Object.keys(slowLog).length > 0) {
                reportsHTML += '<div class="mistake-report"><h3>Questions That Took Time (20+ seconds):</h3><ul>';
                const sortedSlow = Object.entries(slowLog).sort((a, b) => {
                    const avgA = a[1].reduce((sum, t) => sum + t, 0) / a[1].length;
                    const avgB = b[1].reduce((sum, t) => sum + t, 0) / b[1].length;
                    return avgB - avgA;
                });
                for (const [question, times] of sortedSlow) {
                    const avgTime = Math.round(times.reduce((sum, t) => sum + t, 0) / times.length);
                    reportsHTML += `<li>${question} (avg ${avgTime}s)</li>`;
                }
                reportsHTML += '</ul></div>';
            }
            
            if (totalMistakes === 0 && Object.keys(slowLog).length === 0 && Object.keys(fastLog).length === 0) {
                reportsHTML = '<div class="achievement-report"><h3>Perfect! üåü</h3></div>';
            }
            
            reportsContainer.innerHTML = reportsHTML;
        }
        
        function goToNextLevel() {
            const nextLevel = currentLevel + 1;
            if (LEVEL_CONFIG[nextLevel]) {
                currentLevel = nextLevel;
            }

            document.getElementById('completion').style.display = 'none';
            document.getElementById('question-box').style.display = 'block';
            showLevelIntro();
        }
        
        document.getElementById('answer-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkAnswer();
            }
        });
        
        function restartGame() {
            if (confirm('Are you sure you want to restart this level? Your current progress will be lost.')) {
                stopTimer();
                isPaused = false;
                document.getElementById('paused-overlay').classList.remove('visible');
                document.getElementById('pause-button').textContent = '‚è∏Ô∏è Pause';
                
                document.getElementById('completion').style.display = 'none';
                document.getElementById('question-box').style.display = 'block';
                
                showLevelIntro();
            }
        }
        
        function jumpToLevel(level) {
            if (!testMode) return;
            
            const resetSelector = () => {
                document.getElementById('level-selector').value = currentLevel;
            };
            
            if (level === 2 || level === 4) {
                if (level === 2 && (!level1MistakeLog || Object.keys(level1MistakeLog).length === 0)) {
                    alert('Level 2 requires completing Level 1 first to generate practice questions.');
                    resetSelector();
                    return;
                }
                if (level === 4 && (!level3MistakeLog || Object.keys(level3MistakeLog).length === 0)) {
                    alert('Level 4 requires completing Level 3 first to generate practice questions.');
                    resetSelector();
                    return;
                }
            }
            
            stopTimer();
            isPaused = false;
            document.getElementById('paused-overlay').classList.remove('visible');
            document.getElementById('pause-button').textContent = '‚è∏Ô∏è Pause';
            
            document.getElementById('completion').style.display = 'none';
            document.getElementById('question-box').style.display = 'block';
            
            currentLevel = level;
            showLevelIntro();
        }
        
        updateCollectionCount();
        showLevelIntro();
        createGrid();
    </script>
</body>
</html>
